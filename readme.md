

# Cloudflare Worker: ä»£ç†é…ç½®ä¼˜é€‰å·¥å…·

![JavaScript](https://img.shields.io/badge/JavaScript-ES6+-yellow?logo=javascript&logoColor=white) ![Cloudflare Workers](https://img.shields.io/badge/Cloudflare-Workers-F38020?logo=cloudflare&logoColor=white)![D1 Database](https://img.shields.io/badge/Cloudflare-D1-0052CC?logo=cloudflare&logoColor=white)  ![MIT License](https://img.shields.io/badge/License-MIT-green.svg) ![Node.js](https://img.shields.io/badge/Node.js-18+-339933?logo=node.js&logoColor=white)  ![Chart.js](https://img.shields.io/badge/Chart.js-4.0+-FF6384?logo=chart.js&logoColor=white) ![Version](https://img.shields.io/badge/Version-2.0-blue.svg) 

è¿™æ˜¯ä¸€ä¸ªè¿è¡Œåœ¨ Cloudflare Worker ä¸Šçš„å¤šåŠŸèƒ½ä»£ç†å·¥å…·ï¼Œç»“åˆ Cloudflare D1 æ•°æ®åº“ï¼Œæä¾›**IPä¼˜é€‰**å’Œ**åŸŸåä¼˜é€‰**çš„æ‰¹é‡æ›¿æ¢åŠŸèƒ½ã€‚ç³»ç»Ÿç”±3ä¸ªæ–‡ä»¶ç»„æˆï¼š**worker.js** - ä¼˜é€‰ç”Ÿæˆå™¨ã€**config_worker.js** - é…ç½®ç®¡ç†å™¨ã€**mg_worker.js** - ç®¡ç†åå°ã€‚é‡‡ç”¨ä¸‰ Worker æ¶æ„ï¼Œåˆ†åˆ«å¤„ç†ä¼˜é€‰ç”Ÿæˆã€é…ç½®ç®¡ç†å’Œç³»ç»Ÿç®¡ç†ï¼Œå®ç°åŠŸèƒ½è§£è€¦å’Œç‹¬ç«‹éƒ¨ç½²ã€‚

## ğŸ“¦ ç³»ç»Ÿç»„æˆ

**ç³»ç»Ÿç”±3ä¸ªæ ¸å¿ƒæ–‡ä»¶ç»„æˆ**ï¼š

- **`worker.js`** - ä¼˜é€‰ç”Ÿæˆå™¨ï¼šå¤„ç† IP/åŸŸåä¼˜é€‰ã€è®¢é˜…ç”Ÿæˆã€æ‰¹é‡é…ç½®æ›¿æ¢ã€è®¿é—®æ—¥å¿—è®°å½•
- **`config_worker.js`** - é…ç½®ç®¡ç†å™¨ï¼šæä¾›é…ç½® CRUD æ“ä½œã€è®¢é˜…æ¥å£ã€é…ç½®ç¼–è¾‘åŠŸèƒ½ã€UUIDè®¿é—®ç»Ÿè®¡
- **`mg_worker.js`** - ç®¡ç†åå°ï¼šJWT è®¤è¯ã€åŸŸå/IP/UUID ç®¡ç†ã€ç³»ç»Ÿç»Ÿè®¡ã€æ‰‹åŠ¨ IP æ›´æ–°ã€è®¢é˜…è®¿é—®ç»Ÿè®¡åˆ†æ

## âœ¨ ä¸»è¦ç‰¹æ€§

### 1. **ä¸‰ Worker æ¶æ„**

è¯¥ç³»ç»Ÿç”±3ä¸ªæ–‡ä»¶ç»„æˆï¼š**worker.js** - ä¼˜é€‰ç”Ÿæˆå™¨ã€**config_worker.js** - é…ç½®ç®¡ç†å™¨ã€**mg_worker.js** - ç®¡ç†åå°ã€‚

   *   **worker.js** - ä¼˜é€‰ç”Ÿæˆå™¨ï¼šå¤„ç† IP/åŸŸåä¼˜é€‰ã€è®¢é˜…ç”Ÿæˆã€æ‰¹é‡é…ç½®æ›¿æ¢ã€è®¿é—®æ—¥å¿—è®°å½•
   *   **config_worker.js** - é…ç½®ç®¡ç†å™¨ï¼šæä¾›é…ç½® CRUD æ“ä½œã€è®¢é˜…æ¥å£ã€é…ç½®ç¼–è¾‘åŠŸèƒ½ï¼ŒåŒ…å«å¤–éƒ¨é…ç½®ç”Ÿæˆå™¨é“¾æ¥å’ŒUUIDè®¿é—®ç»Ÿè®¡
   *   **mg_worker.js** - ç®¡ç†åå°ï¼šJWT è®¤è¯ã€åŸŸå/IP/UUID ç®¡ç†ã€ç³»ç»Ÿç»Ÿè®¡ã€æ‰‹åŠ¨ IP æ›´æ–°ã€è®¢é˜…è®¿é—®ç»Ÿè®¡åˆ†æ

### 2. **åŒæ¨¡å¼ä¼˜é€‰**

   *   æ”¯æŒå°†é…ç½®ä¸­çš„åœ°å€æ‰¹é‡æ›¿æ¢ä¸º **ä¼˜é€‰ IP** æˆ– **ä¼˜é€‰åŸŸå**
   *   æ”¯æŒ IPv4/IPv6 å’Œä¸åŒè¿è¥å•†ï¼ˆç”µä¿¡/è”é€š/ç§»åŠ¨ï¼‰ç­›é€‰
   *   æ”¯æŒé€šè¿‡ç®¡ç†åå°æ‰‹åŠ¨æ›´æ–° IP æ•°æ®æº

### 3. **é…ç½®ç®¡ç† (CRUD) [v1.2]**

   *   æä¾›å®Œæ•´çš„ç®¡ç†ç•Œé¢ï¼Œå¯æ·»åŠ ã€æŸ¥è¯¢ã€ç¼–è¾‘ã€åˆ é™¤åŸºç¡€é…ç½®ï¼ˆæ”¯æŒ VMess, VLESS, Trojanï¼‰
   *   æŒ‰ UUID åˆ†ç»„ç®¡ç†ï¼Œæ–¹ä¾¿ç”Ÿæˆä¸åŒçš„è®¢é˜…
   *   æ”¯æŒé…ç½®ç¼–è¾‘åŠŸèƒ½ï¼Œå¯ä¿®æ”¹åˆ«åã€åœ°å€ã€ç«¯å£ã€ä¼ è¾“åè®®ç­‰å‚æ•°
   *   æä¾›é…ç½®ç”Ÿæˆå™¨å¤–éƒ¨é“¾æ¥ï¼ˆ"é…ç½®ç”Ÿæˆ"æŒ‰é’®ï¼‰ï¼Œé“¾æ¥åˆ°å¤–éƒ¨é…ç½®ç”Ÿæˆå™¨ï¼ˆhttps://cfst.api.yangzifun.orgï¼‰
   *   æ”¹è¿›çš„è®¢é˜…é“¾æ¥æ˜¾ç¤ºæ–¹å¼ï¼ˆä½¿ç”¨å¯å¤åˆ¶çš„è¾“å…¥æ¡†ï¼‰
   *   ç»Ÿä¸€çš„å‰ç«¯æŒ‰é’®æ ·å¼

### 4. **åŠ¨æ€è®¢é˜…ç”Ÿæˆ**

   *   æä¾› `/sub/{uuid}` è®¢é˜…æ¥å£ï¼Œè¿”å› Base64 ç¼–ç çš„é…ç½®åˆ—è¡¨
   *   æ”¯æŒé€šè¿‡ URL å‚æ•°åŠ¨æ€æŒ‡å®š IP ç±»å‹ï¼ˆIPv4/IPv6ï¼‰æˆ–è¿è¥å•†ï¼ˆç”µä¿¡/è”é€š/ç§»åŠ¨ï¼‰
   *   æ”¯æŒæ‰¹é‡æ·»åŠ é…ç½®ï¼Œæé«˜ç®¡ç†æ•ˆç‡

### 5. **è®¿é—®æ—¥å¿—è®°å½• [v2.0æ–°å¢]**

   *   **å®Œæ•´çš„è®¿é—®ç»Ÿè®¡**ï¼šè®°å½•ç”¨æˆ·é€šè¿‡UUIDç”Ÿæˆé…ç½®çš„æ‰€æœ‰è®¿é—®
   *   **åŒæ¨¡å¼è®°å½•**ï¼š
       - è®¢é˜…é“¾æ¥è®¿é—® (`subscription`)
       - ç½‘é¡µAPIç”Ÿæˆè®¿é—® (`api-generation`)
   *   **å®¢æˆ·ç«¯ä¿¡æ¯æ”¶é›†**ï¼šè®°å½•å®¢æˆ·ç«¯IPã€User-Agent
   *   **å®æ—¶ç»Ÿè®¡API**ï¼šæä¾›`/admin/stats`æ¥å£è·å–è¯¦ç»†çš„è®¿é—®ç»Ÿè®¡æ•°æ®
   *   **æ±‡æ€»åˆ†æ**ï¼šæ”¯æŒæŒ‰æ—¥æœŸã€UUIDã€è®¿é—®ç±»å‹è¿›è¡Œå¤šç»´åº¦ç»Ÿè®¡

### 6. **è®¢é˜…åˆ†æåŠŸèƒ½ [v2.0æ–°å¢]**

   *   **ç®¡ç†åå°è®¢é˜…åˆ†æ**ï¼šåœ¨ç®¡ç†åå°æä¾›å…¨å±€è®¿é—®åˆ†æ
   *   **é…ç½®é¡µé¢UUIDç»Ÿè®¡**ï¼šåœ¨é…ç½®ç®¡ç†é¡µé¢ä¸ºæ¯ä¸ªUUIDæä¾›ä¸“å±ç»Ÿè®¡å›¾è¡¨
   *   **äº¤äº’å¼è¶‹åŠ¿å›¾è¡¨**ï¼šä½¿ç”¨Chart.jså¯è§†åŒ–è¿‘7/14/30/60å¤©çš„è®¿é—®è¶‹åŠ¿
   *   **å¤šç»´åº¦åˆ†æ**ï¼š
       - æ€»è®¿é—®é‡è¶‹åŠ¿
       - è®¢é˜…è®¿é—® vs ç½‘é¡µç”Ÿæˆè®¿é—®å¯¹æ¯”
   *   **å®æ—¶æ•°æ®æ›´æ–°**ï¼šæ”¯æŒæ‰‹åŠ¨åˆ·æ–°ç»Ÿè®¡æ•°æ®
   *   **è¯¦ç»†è®¿é—®è®°å½•**ï¼šæ˜¾ç¤ºæœ€è¿‘è®¿é—®è®°å½•å’Œå®¢æˆ·ç«¯ä¿¡æ¯

### 7. **å®Œæ•´çš„æ•°æ®ç®¡ç†**

   *   åŸŸåç®¡ç†ï¼šæ·»åŠ ã€ç¼–è¾‘ã€åˆ é™¤ä¼˜é€‰åŸŸå
   *   IP èµ„æºæ± ç®¡ç†ï¼šæŸ¥çœ‹ã€åˆ é™¤ã€åˆ·æ–°ä¼˜é€‰ IP
   *   UUID åˆ†ç»„ç®¡ç†ï¼šæŒ‰ UUID ç®¡ç†é…ç½®åˆ†ç»„
   *   ç³»ç»Ÿç»Ÿè®¡ï¼šå®æ—¶æŸ¥çœ‹åŸŸåã€IPã€UUID æ•°é‡ç»Ÿè®¡

### 8. **å®‰å…¨ç‰¹æ€§**

*   JWT è®¤è¯ç³»ç»Ÿï¼Œä¿éšœç®¡ç†åå°å®‰å…¨
*   **MFAåŒé‡éªŒè¯**ï¼š
    - æ”¯æŒTOTP(åŸºäºæ—¶é—´çš„ä¸€æ¬¡æ€§å¯†ç )éªŒè¯
    - ç®¡ç†å‘˜å¯å¯ç”¨/ç¦ç”¨MFA
    - æä¾›10ä¸ªä¸€æ¬¡æ€§å¤‡ä»½ç ï¼Œé˜²æ­¢éªŒè¯å™¨ä¸¢å¤±
    - æ”¯æŒä½¿ç”¨å¤‡ä»½ç ç™»å½•
*   å“åº”å¼è®¾è®¡ï¼Œé€‚é…æ¡Œé¢å’Œç§»åŠ¨è®¾å¤‡
*   é…ç½®ç”Ÿæˆå™¨å¤–éƒ¨é“¾æ¥è·³è½¬åŠŸèƒ½ï¼Œæä¾›ä¸€ç«™å¼é…ç½®ç®¡ç†ä½“éªŒ

## ğŸ› ï¸ éƒ¨ç½²å‡†å¤‡

åœ¨ä½¿ç”¨æ­¤è„šæœ¬ä¹‹å‰ï¼Œæ‚¨éœ€è¦ï¼š

1.  ä¸€ä¸ª **Cloudflare** è´¦å·ã€‚
2.  å¯ç”¨ **Workers** å’Œ **D1 Database** åŠŸèƒ½ã€‚

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### 1. åˆ›å»º D1 æ•°æ®åº“

åœ¨ Cloudflare æ§åˆ¶å°çš„ "Workers & Pages" -> "D1" ä¸­åˆ›å»ºä¸€ä¸ªæ–°çš„æ•°æ®åº“ï¼ˆä¾‹å¦‚å‘½åä¸º `proxy-db`ï¼‰ã€‚

### 2. åˆå§‹åŒ–æ•°æ®åº“ (SQL)

è¿›å…¥ D1 æ•°æ®åº“çš„ "Console" æ ‡ç­¾é¡µï¼Œæ‰§è¡Œä»¥ä¸‹ SQL è¯­å¥ä»¥åˆ›å»ºæ‰€éœ€çš„è¡¨ç»“æ„ï¼š

```sql
/* =================================================================
 *  D1 æ•°æ®åº“å»ºè¡¨ Schema
 * ================================================================= */

-- ç”¨æˆ·è¡¨
CREATE TABLE IF NOT EXISTS admin_users (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    username TEXT UNIQUE,
    password_hash TEXT
);
-- åŸŸåè¡¨
CREATE TABLE IF NOT EXISTS cf_domains (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    domain TEXT UNIQUE,
    remark TEXT,
    created_at INTEGER
);
-- UUID é…ç½®è¡¨
CREATE TABLE IF NOT EXISTS configs (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    uuid TEXT,
    config TEXT, 
    created_at INTEGER
);
-- IP æ± è¡¨
CREATE TABLE IF NOT EXISTS cfips (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    ip TEXT UNIQUE,
    ip_type TEXT,
    carrier TEXT,
    created_at INTEGER
);
-- è‡ªåŠ¨æ›´æ–°è®¾ç½®è¡¨ (v1.3æ–°å¢)
CREATE TABLE IF NOT EXISTS auto_update_settings (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    source TEXT UNIQUE NOT NULL,
    enabled INTEGER DEFAULT 1,
    updated_at INTEGER DEFAULT (unixepoch())
);

-- MFA å¯†é’¥è¡¨ (v1.4æ–°å¢)
CREATE TABLE IF NOT EXISTS mfa_secrets (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER NOT NULL,
    secret TEXT NOT NULL,
    created_at INTEGER DEFAULT (unixepoch()),
    FOREIGN KEY (user_id) REFERENCES admin_users(id) ON DELETE CASCADE
);

-- MFA å¤‡ä»½ç è¡¨ (v1.4æ–°å¢)
CREATE TABLE IF NOT EXISTS mfa_backup_codes (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER NOT NULL,
    code TEXT NOT NULL,
    used INTEGER DEFAULT 0,
    created_at INTEGER DEFAULT (unixepoch()),
    FOREIGN KEY (user_id) REFERENCES admin_users(id) ON DELETE CASCADE
);

-- è®¿é—®æ—¥å¿—è¡¨ (v2.0æ–°å¢)
CREATE TABLE IF NOT EXISTS config_access_logs (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    uuid TEXT NOT NULL,
    query_type TEXT NOT NULL,  -- è®°å½•ç±»å‹: 'subscription' æˆ– 'api-generation'
    client_ip TEXT,
    user_agent TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ä¸ºè®¿é—®æ—¥å¿—æ·»åŠ ç´¢å¼•ä»¥ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½
CREATE INDEX IF NOT EXISTS idx_access_logs_uuid ON config_access_logs(uuid);
CREATE INDEX IF NOT EXISTS idx_access_logs_date ON config_access_logs(DATE(created_at));
CREATE INDEX IF NOT EXISTS idx_access_logs_type ON config_access_logs(query_type);

-- åˆå§‹åŒ–ç®¡ç†å‘˜ (è´¦å·: admin / å¯†ç : password)
-- Hash å€¼æ˜¯ "password" çš„ SHA-256
INSERT INTO admin_users (username, password_hash) VALUES ('admin', '5e884898da28047151d0e56f8dc6292773603d0d6aabbdd62a11ef721d1542d8');

-- åˆå§‹åŒ–è‡ªåŠ¨æ›´æ–°è®¾ç½® (v1.3æ–°å¢)
INSERT OR IGNORE INTO auto_update_settings (source, enabled) VALUES 
('global', 1),
('hostmonit', 1),
('vps789', 1);
```

### 3. åˆ›å»ºWorkerå¹¶ç»‘å®šD1

åˆ›å»ºä¸‰ä¸ªWorkerå¹¶ç»‘å®šåˆ°åŒä¸€ä¸ªD1æ•°æ®åº“ï¼š

| Workeråç§°     | ç»‘å®šæ–‡ä»¶           | æ•°æ®åº“ç»‘å®šå˜é‡ |
| -------------- | ------------------ | -------------- |
| `proxy-main`   | `worker.js`        | `DB`           |
| `proxy-config` | `config_worker.js` | `DB`           |
| `proxy-mg`     | `mg_worker.js`     | `DB`           |

ç»‘å®šæ­¥éª¤ï¼š

1. æ¯ä¸ªWorkerçš„"Settings" â†’ "Variables"ä¸­æ·»åŠ D1ç»‘å®š

2. **Variable name** å¿…é¡»è®¾ç½®ä¸º `DB`ï¼ˆåŒºåˆ†å¤§å°å†™ï¼‰

3. é€‰æ‹©å‰é¢åˆ›å»ºçš„D1æ•°æ®åº“

4. **è·¯ç”±é…ç½®**ï¼š

   *   åœ¨ DNS è®¾ç½®ä¸­åˆ›å»ºä¸‰æ¡è·¯ç”±ï¼š

   ```
   proxy.example.com/* â†’ proxy-main
   config.example.com/* â†’ proxy-config
   mg.example.com/* â†’ proxy-mg
   ```

5. **é‡è¦é…ç½®**ï¼šè¿›å…¥æ¯ä¸ª Worker çš„ **Settings** -> **Variables**ï¼š

   *   **D1 Database Bindings**ï¼š
   *   **Variable name**: `DB` (å¿…é¡»å®Œå…¨ä¸€è‡´ï¼Œæ³¨æ„å¤§å†™)
   *   **D1 database**: é€‰æ‹©ç¬¬ 1 æ­¥åˆ›å»ºçš„æ•°æ®åº“ã€‚

### 4. åˆå§‹åŒ–åŸŸåè¡¨ (å¯é€‰)

åœ¨é…ç½®ç®¡ç†é¡µ(`/manage`)ä¸Šçº¿åï¼Œæ‚¨å¯ä»¥ç›´æ¥åœ¨UIä¸­æ·»åŠ åŸŸåï¼š

1. è®¿é—®Workeråœ°å€ + `/manage`
2. åˆ‡æ¢åˆ°"åŸŸåç®¡ç†"æ ‡ç­¾é¡µ
3. ç‚¹å‡»"æ·»åŠ åŸŸå"æŒ‰é’®
4. è¾“å…¥åŸŸåå’Œå¤‡æ³¨ä¿¡æ¯

æˆ–è€…é€šè¿‡SQLåˆå§‹åŒ–ï¼š

```sql
INSERT INTO cf_domains (domain, remark) VALUES 
('example.com', 'ä¼˜è´¨åŸŸå'),
('cdn.example.net', 'CDNåŠ é€ŸåŸŸå');
```

### 5. éƒ¨ç½²ä¸Šçº¿

ç‚¹å‡» "Deploy" ä¿å­˜å¹¶å‘å¸ƒ Workerã€‚è®¿é—® Worker çš„ URL å³å¯çœ‹åˆ°æ“ä½œç•Œé¢ã€‚

---

## ğŸ“– ä½¿ç”¨æŒ‡å—

### 1. é¦–é¡µ (æ‰¹é‡ç”Ÿæˆå™¨)

*   **åŸºç¡€é…ç½®**ï¼š
    *   **æ‰‹åŠ¨ç²˜è´´**ï¼šç›´æ¥å°† vmess/vless é“¾æ¥ç²˜è´´åˆ°æ–‡æœ¬æ¡†ã€‚
    *   **ä» UUID è·å–**ï¼šè¾“å…¥åœ¨ç®¡ç†é¡µä¿å­˜çš„ UUIDï¼Œè„šæœ¬ä¼šè‡ªåŠ¨æ‹‰å–è¯¥ç»„æ‰€æœ‰é…ç½®ã€‚
*   **ä¼˜é€‰åˆ—è¡¨**ï¼š
    *   **IP åœ°å€**ï¼šé€‰æ‹© IPv4/IPv6 æˆ–ç‰¹å®šè¿è¥å•†ã€‚å¦‚æœIPæ± ä¸ºç©ºï¼Œè¯·ç‚¹å‡»"ä»è¿œç¨‹APIæ›´æ–°"æŒ‰é’®æ‰‹åŠ¨è·å–IPã€‚
    *   **ä¼˜é€‰åŸŸå**ï¼šç›´æ¥ä½¿ç”¨æ•°æ®åº“ `cf_domains` è¡¨ä¸­çš„åŸŸåã€‚
*   **ç”Ÿæˆé…ç½®**ï¼šç‚¹å‡»æŒ‰é’®ï¼Œåº•éƒ¨æ–‡æœ¬æ¡†å°†æ˜¾ç¤ºæ›¿æ¢åçš„èŠ‚ç‚¹åˆ—è¡¨ã€‚
*   **è®¿é—®æ—¥å¿—**ï¼šä½¿ç”¨UUIDç”Ÿæˆé…ç½®ä¼šè‡ªåŠ¨è®°å½•è®¿é—®æ—¥å¿—ï¼Œç”¨äºåå°ç»Ÿè®¡ã€‚

### 2. é…ç½®ç®¡ç†é¡µ (`/manage`)

*   åœ¨æ­¤é¡µé¢ï¼Œæ‚¨å¯ä»¥ï¼š
    *   **ç®¡ç†åŸºç¡€é…ç½®**ï¼šæ·»åŠ /æŸ¥è¯¢/åˆ é™¤èŠ‚ç‚¹é…ç½®
    *   **æŸ¥çœ‹UUIDç»Ÿè®¡**ï¼šä¸ºå½“å‰æŸ¥è¯¢çš„UUIDæ˜¾ç¤ºè®¿é—®ç»Ÿè®¡å›¾è¡¨
    *   **æ·»åŠ æ–°é…ç½®**ï¼šæ‰¹é‡æ·»åŠ æ–°çš„é…ç½®èŠ‚ç‚¹
*   **æ“ä½œæŒ‡å—**ï¼š
    1. åœ¨"æ£€ç´¢è®¢é˜…"å¡ç‰‡ï¼š
       - **è¾“å…¥UUID**ï¼šè¾“å…¥è¦æŸ¥è¯¢çš„UUID
       - **ç‚¹å‡»æŸ¥è¯¢**ï¼šæŸ¥çœ‹è¯¥UUIDä¸‹çš„æ‰€æœ‰é…ç½®
    2. åœ¨"é…ç½®åˆ—è¡¨"å¡ç‰‡ï¼š
       - **ç¼–è¾‘é…ç½®**ï¼šç‚¹å‡»ç¼–è¾‘æŒ‰é’®ä¿®æ”¹é…ç½®å‚æ•°
       - **åˆ é™¤é…ç½®**ï¼šåˆ é™¤å•ä¸ªé…ç½®æˆ–æ•´ä¸ªUUIDç»„
    3. åœ¨"è®¿é—®ç»Ÿè®¡"å¡ç‰‡ï¼š
       - **æŸ¥çœ‹è¶‹åŠ¿å›¾**ï¼šé€‰æ‹©æ—¶é—´èŒƒå›´ï¼ˆ7/14/30/60å¤©ï¼‰æŸ¥çœ‹è®¿é—®è¶‹åŠ¿
       - **åˆ‡æ¢å›¾è¡¨ç±»å‹**ï¼šæŸ¥çœ‹æ€»è®¿é—®é‡æˆ–åˆ†ç±»ç»Ÿè®¡
       - **æŸ¥çœ‹è®¿é—®è®°å½•**ï¼šæŸ¥çœ‹æœ€è¿‘çš„è®¿é—®è®°å½•å’Œå®¢æˆ·ç«¯ä¿¡æ¯
    4. åœ¨"æ·»åŠ æ–°èŠ‚ç‚¹"å¡ç‰‡ï¼š
       - **æ‰¹é‡æ·»åŠ é…ç½®**ï¼šæ”¯æŒvmess/vless/trojané“¾æ¥æ‰¹é‡æ·»åŠ 

### 3. ç®¡ç†åå° (`/login`)

*   åœ¨æ­¤é¡µé¢ï¼Œæ‚¨å¯ä»¥ï¼š
    *   **ç³»ç»Ÿæ¦‚è§ˆ**ï¼šæŸ¥çœ‹ç³»ç»ŸçŠ¶æ€å’Œè®¿é—®æ‘˜è¦
    *   **åŸŸåç®¡ç†**ï¼šæ·»åŠ /ç¼–è¾‘/åˆ é™¤ä¼˜é€‰åŸŸå
    *   **IPèµ„æºæ± ç®¡ç†**ï¼šç®¡ç†IPæ± å’Œè‡ªåŠ¨æ›´æ–°è®¾ç½®
    *   **é…ç½®åˆ†çµ„ç®¡ç†**ï¼šæŸ¥çœ‹å’Œç®¡ç†UUIDåˆ†ç»„
    *   **è®¢é˜…åˆ†æ**ï¼šå…¨å±€è®¿é—®ç»Ÿè®¡åˆ†æ
    *   **å®‰å…¨ä¸­å¿ƒ**ï¼šç®¡ç†MFAåŒé‡éªŒè¯

### 4. è®¢é˜…é“¾æ¥

ç”Ÿæˆé…ç½®åï¼Œå¦‚æœä½¿ç”¨äº† UUID æ¨¡å¼ï¼Œç³»ç»Ÿä¼šæä¾›ä¸€ä¸ªæ°¸ä¹…è®¢é˜…é“¾æ¥ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š

*   **IP æ¨¡å¼**: `/batch-configs/{uuid}?type=ip&ipType=v4&carrier=CT`
*   **åŸŸå æ¨¡å¼**: `/batch-configs/{uuid}?type=domain`

---

## âš™ï¸ ç³»ç»Ÿæ¶æ„

### ç»„ä»¶äº¤äº’æµç¨‹

```mermaid
sequenceDiagram
    participant User as ç”¨æˆ·æµè§ˆå™¨
    participant Main as worker.js
    participant Config as config_worker.js
    participant DB as D1 æ•°æ®åº“
    participant Mg as mg_worker.js

    User->>Config: è®¿é—® /manage (é…ç½®ç®¡ç†)
    Config->>DB: è¯»å†™é…ç½®æ•°æ®
    Config-->>User: è¿”å›ç®¡ç†ç•Œé¢

    User->>Main: è®¿é—® / (ç”Ÿæˆå™¨é¦–é¡µ)
    Main->>DB: è¯»å–ä¼˜é€‰IP/åŸŸå
    Main-->>User: è¿”å›ç”Ÿæˆå™¨ç•Œé¢

    User->>Main: æäº¤ç”Ÿæˆè¯·æ±‚
    Main->>DB: è·å–åŸºç¡€é…ç½®
    Main->>DB: è®°å½•è®¿é—®æ—¥å¿—(å¦‚ä½¿ç”¨UUID)
    Main-->>User: è¿”å›ä¼˜é€‰èŠ‚ç‚¹
  
    User->>Config: æŸ¥è¯¢UUIDé…ç½®
    Config->>DB: è·å–é…ç½®åˆ—è¡¨
    Config->>DB: è·å–è®¿é—®ç»Ÿè®¡
    Config-->>User: è¿”å›é…ç½®åˆ—è¡¨å’Œç»Ÿè®¡å›¾è¡¨
  
    User->>Mg: è®¿é—® /analytics (è®¢é˜…åˆ†æ)
    Mg->>DB: æŸ¥è¯¢è®¿é—®æ—¥å¿—ç»Ÿè®¡
    Mg-->>User: è¿”å›åˆ†æå›¾è¡¨å’Œæ’è¡Œ
```

### æ¥å£è°ƒç”¨å…³ç³»

| è°ƒç”¨æ–¹      | è¢«è°ƒç”¨æ–¹           | æ¥å£è·¯å¾„              | æ•°æ®æµå‘             |
| ----------- | ------------------ | --------------------- | -------------------- |
| `worker.js` | `config_worker.js` | `/config`             | æ‹‰å–åŸºç¡€é…ç½®         |
| `worker.js` | `config_worker.js` | `/domain`             | è·å–ä¼˜é€‰åŸŸå         |
| ç”¨æˆ·æµè§ˆå™¨  | `mg_worker.js`     | `/manage` ç›¸å…³æ¥å£    | ç®¡ç†åå°æ“ä½œ         |
| ç”¨æˆ·æµè§ˆå™¨  | `mg_worker.js`     | `/update-ips`         | æ‰‹åŠ¨æ›´æ–°IP           |
| ç”¨æˆ·æµè§ˆå™¨  | `mg_worker.js`     | `/analytics`          | å…¨å±€è®¢é˜…ç»Ÿè®¡åˆ†æ     |
| ç”¨æˆ·æµè§ˆå™¨  | `config_worker.js` | `/manage/stats/:uuid` | æŸ¥è¯¢ç‰¹å®šUUIDè®¿é—®ç»Ÿè®¡ |

## ğŸ“¡ API æ¥å£æ–‡æ¡£

### mg_worker.js æ¥å£ï¼š

| æ–¹æ³•     | è·¯å¾„                        | æè¿°             | å‚æ•°ç¤ºä¾‹              |
| :------- | :-------------------------- | :--------------- | :-------------------- |
| `GET`    | `/manage`                   | ç®¡ç†åå°UI       | -                     |
| `POST`   | `/login`                    | ç®¡ç†å‘˜ç™»å½•       | JSON body             |
| `GET`    | `/domains`                  | è·å–åŸŸååˆ—è¡¨     | -                     |
| `POST`   | `/domain`                   | æ·»åŠ åŸŸå         | JSON body             |
| `DELETE` | `/domain/:id`               | åˆ é™¤åŸŸå         | URLå‚æ•°               |
| `GET`    | `/ips`                      | è·å–IPåˆ—è¡¨       | `?page=1&per_page=20` |
| `POST`   | `/update-ips`               | æ‰‹åŠ¨æ›´æ–°IPæ±      | -                     |
| `GET`    | `/uuids`                    | è·å–UUIDåˆ—è¡¨     | -                     |
| `GET`    | `/api/settings/auto-update` | è·å–è‡ªåŠ¨æ›´æ–°è®¾ç½® | -                     |
| `POST`   | `/api/settings/auto-update` | æ›´æ–°è‡ªåŠ¨æ›´æ–°è®¾ç½® | JSON body             |

### worker.js æ¥å£ (v2.0+)ï¼š

| æ–¹æ³•  | è·¯å¾„           | æè¿°             | å‚æ•°ç¤ºä¾‹                                                 |
| :---- | :------------- | :--------------- | :------------------------------------------------------- |
| `GET` | `/admin/stats` | è·å–è®¿é—®ç»Ÿè®¡æ•°æ® | `?uuid={uuid}&start_date=2024-01-01&end_date=2024-12-31` |

### config_worker.js æ¥å£ (v2.0+)ï¼š

| æ–¹æ³•     | è·¯å¾„                     | æè¿°             | å‚æ•°ç¤ºä¾‹              |
| :------- | :----------------------- | :--------------- | :-------------------- |
| `GET`    | `/manage/stats/:uuid`    | è·å–UUIDè®¿é—®ç»Ÿè®¡ | `?days=30` (é»˜è®¤30å¤©) |
| `GET`    | `/manage/configs/:uuid`  | è·å–UUIDé…ç½®åˆ—è¡¨ | -                     |
| `POST`   | `/manage/configs`        | æ·»åŠ é…ç½®         | JSON body             |
| `PUT`    | `/manage/configs`        | æ›´æ–°é…ç½®         | JSON body             |
| `DELETE` | `/manage/configs/:uuid`  | åˆ é™¤æ•´ä¸ªUUIDç»„   | -                     |
| `DELETE` | `/manage/configs/id/:id` | åˆ é™¤å•ä¸ªé…ç½®     | -                     |

### mg_worker.js æ–°å¢æ¥å£ (v2.0+)ï¼š

| æ–¹æ³•  | è·¯å¾„                      | æè¿°                 | å‚æ•°ç¤ºä¾‹                                   |
| :---- | :------------------------ | :------------------- | :----------------------------------------- |
| `GET` | `/api/stats`              | è·å–ç³»ç»ŸåŠè®¿é—®ç»Ÿè®¡   | `?days=30` (é»˜è®¤30å¤©)                      |
| `GET` | `/api/stats/uuid-details` | è·å–UUIDè¯¦ç»†è®¿é—®è®°å½• | `?uuid={uuid}&start_date=xxx&end_date=xxx` |

### ç»Ÿè®¡æ¥å£è¯´æ˜

#### 1. è·å–UUIDè®¿é—®ç»Ÿè®¡ (`GET /manage/stats/:uuid`)

è¿”å›æŒ‡å®šUUIDçš„è¯¦ç»†è®¿é—®ç»Ÿè®¡ä¿¡æ¯ï¼Œæ”¯æŒæ—¶é—´èŒƒå›´å‚æ•°ï¼š

- **days**: æŸ¥è¯¢å¤©æ•°ï¼ˆ7/14/30/60å¤©ï¼‰

å“åº”æ ¼å¼ç¤ºä¾‹ï¼š

```json
{
  "success": true,
  "uuid": "my-uuid-123",
  "total_access": 150,
  "subscription_count": 120,
  "apigen_count": 30,
  "first_access": "2024-01-15T08:30:00Z",
  "last_access": "2024-01-20T14:45:00Z",
  "today_total": 15,
  "today_subscription": 12,
  "today_apigen": 3,
  "daily_stats": [
    {
      "date": "2024-01-20",
      "total": 25,
      "subscription": 20,
      "api_generation": 5
    }
  ],
  "recent_logs": [
    {
      "uuid": "my-uuid-123",
      "query_type": "subscription",
      "client_ip": "123.123.123.123",
      "user_agent": "Clash/2.0",
      "created_at": "2024-01-20T14:45:00Z"
    }
  ]
}
```

#### 2. è·å–ç³»ç»Ÿç»Ÿè®¡ (`GET /api/stats`)

è¿”å›å®Œæ•´çš„ç³»ç»Ÿç»Ÿè®¡ä¿¡æ¯ï¼ŒåŒ…æ‹¬ï¼š

- **åŸºç¡€ç»Ÿè®¡**: åŸŸåæ•°ã€IPæ•°ã€UUIDåˆ†ç»„æ•°ã€è‡ªåŠ¨æ›´æ–°çŠ¶æ€
- **è®¿é—®ç»Ÿè®¡**: æ€»è®¿é—®æ¬¡æ•°ã€ä»Šæ—¥è®¿é—®ã€è®¢é˜…è®¿é—®ã€ç½‘é¡µç”Ÿæˆè®¿é—®
- **è¶‹åŠ¿æ•°æ®**: è¿‘Nå¤©çš„æ¯æ—¥è®¿é—®æ•°æ®
- **çƒ­é—¨UUID**: è®¿é—®æ¬¡æ•°æœ€å¤šçš„UUIDæ’è¡Œ

å“åº”æ ¼å¼ç¤ºä¾‹ï¼š

```json
{
  "domains": 15,
  "ips": 256,
  "uuids": 8,
  "autoUpdate": 1,
  "lastExecuted": 1707907200000,
  "access_stats": {
    "success": true,
    "total_requests": 150,
    "unique_uuids": 8,
    "subscription_requests": 120,
    "api_generation_requests": 30,
    "today_total": 15,
    "today_subscription": 12,
    "today_apigen": 3,
    "daily_stats": [...],
    "popular_uuids": [...]
  }
}
```

#### 3. è·å–UUIDè¯¦ç»†è®¿é—®è®°å½• (`GET /api/stats/uuid-details`)

è¿”å›æŒ‡å®šUUIDçš„è¯¦ç»†è®¿é—®è®°å½•ï¼Œæ”¯æŒæ—¶é—´èŒƒå›´ç­›é€‰ã€‚

å“åº”æ ¼å¼ç¤ºä¾‹ï¼š

```json
{
  "success": true,
  "uuid": "my-config-group",
  "total_access": 45,
  "first_access": "2024-01-15T08:30:00Z",
  "last_access": "2024-01-20T14:45:00Z",
  "access_logs": [
    {
      "uuid": "my-config-group",
      "query_type": "subscription",
      "client_ip": "123.123.123.123",
      "user_agent": "Clash/2.0",
      "created_at": "2024-01-20T14:45:00Z"
    }
  ]
}
```

### MFAç›¸å…³æ¥å£ï¼š

| æ–¹æ³•   | è·¯å¾„                               | æè¿°                        |
| ------ | ---------------------------------- | --------------------------- |
| `POST` | `/api/mfa/init`                    | åˆå§‹åŒ–MFAï¼Œè·å–å¯†é’¥å’ŒäºŒç»´ç  |
| `POST` | `/api/mfa/verify-first`            | é¦–æ¬¡éªŒè¯MFAå¹¶å¯ç”¨           |
| `POST` | `/api/mfa/login-with-backup`       | ä½¿ç”¨å¤‡ä»½ç ç™»å½•              |
| `GET`  | `/api/mfa/status`                  | è·å–MFAçŠ¶æ€                 |
| `POST` | `/api/mfa/disable`                 | ç¦ç”¨MFA                     |
| `POST` | `/api/mfa/backup-codes/regenerate` | é‡æ–°ç”Ÿæˆå¤‡ä»½ç               |

### è‡ªåŠ¨æ›´æ–°è®¾ç½®æ¥å£è¯´æ˜

- **è·å–è‡ªåŠ¨æ›´æ–°è®¾ç½®** (`GET /api/settings/auto-update`): 
  è¿”å›å½“å‰è‡ªåŠ¨æ›´æ–°é…ç½®ï¼ŒåŒ…æ‹¬æ¯ä¸ªæ•°æ®æºï¼ˆglobal, hostmonit, vps789ï¼‰çš„å¯ç”¨çŠ¶æ€

- **æ›´æ–°è‡ªåŠ¨æ›´æ–°è®¾ç½®** (`POST /api/settings/auto-update`): 
  æ›´æ–°è‡ªåŠ¨æ›´æ–°é…ç½®ã€‚è¯·æ±‚ä½“ä¸ºJSONæ ¼å¼ï¼Œç¤ºä¾‹ï¼š

  ```json
  { 
    "source": "hostmonit", 
    "enabled": true 
  }
  ```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1.  **æ–‡ä»¶åˆ†å·¥**ï¼š
    *   `worker.js` å¤„ç†ä¼˜é€‰é€»è¾‘å’Œè®¢é˜…ç”Ÿæˆï¼Œæ–°å¢è®¿é—®æ—¥å¿—è®°å½•åŠŸèƒ½
    *   `config_worker.js` ä¸“æ³¨é…ç½®ç®¡ç† CRUD æ“ä½œå’ŒUUIDç»Ÿè®¡
    *   `mg_worker.js` å¤„ç†ç³»ç»Ÿç®¡ç†ã€JWTè®¤è¯å’Œç»Ÿè®¡åˆ†æ

2.  **IP æ›´æ–°**ï¼š
    *   ç³»ç»Ÿé»˜è®¤å¼€å¯è‡ªåŠ¨æ›´æ–°IPæ± ï¼Œå¯åœ¨ç®¡ç†åå°é…ç½®
    *   æ”¯æŒå…¨å±€å¼€å…³å’ŒæŒ‰æ¥å£æºå•ç‹¬é…ç½®

3.  **åŸŸåç®¡ç†**ï¼š
    *   é€šè¿‡ SQL å‘½ä»¤ç»´æŠ¤ `cf_domains` è¡¨ï¼š`INSERT INTO cf_domains (domain, remark) VALUES ('example.com', 'ä¼˜è´¨åŸŸå')`
    *   æ”¯æŒåœ¨é…ç½®ç®¡ç†é¡µ(`/manage`)ç›´æ¥ç®¡ç†åŸŸåï¼ˆv1.2+æ–°åŠŸèƒ½ï¼‰

4.  **è®¿é—®æ—¥å¿—ä¸ç»Ÿè®¡**ï¼š
    *   ä»…è®°å½•é€šè¿‡UUIDç”Ÿæˆé…ç½®çš„è®¿é—®ï¼Œæ‰‹åŠ¨ç²˜è´´é…ç½®ä¸è®°å½•
    *   è®¿é—®æ—¥å¿—å¼‚æ­¥è®°å½•ï¼Œä¸å½±å“ä¸»ä¸šåŠ¡æµç¨‹
    *   åŒ…å«å®¢æˆ·ç«¯IPå’ŒUser-Agentä¿¡æ¯ï¼Œå¯ç”¨äºå®‰å…¨åˆ†æ
    *   ç»Ÿè®¡åˆ†ææ•°æ®åŸºäºè®¿é—®æ—¥å¿—è¡¨ï¼Œæ”¯æŒå¤šç»´åº¦æŸ¥è¯¢
    *   éœ€è¦åœ¨`config_access_logs`è¡¨ä¸­åˆ›å»ºç´¢å¼•ä»¥ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½

5.  **VMess æ ¼å¼**ï¼šä»£ç ä»…æ”¯æŒæ ‡å‡†çš„ JSON æ ¼å¼ Base64 ç¼–ç çš„ VMess é“¾æ¥ã€‚

6.  **é…ç½®åŒæ­¥**ï¼šé€šè¿‡ `config_worker.js` ç®¡ç†çš„é…ç½®ä¼šå®æ—¶åŒæ­¥åˆ° D1 æ•°æ®åº“ã€‚

7.  **å›¾è¡¨ä¾èµ–**ï¼šè®¢é˜…åˆ†æåŠŸèƒ½ä½¿ç”¨Chart.jsåº“ï¼Œéœ€è¦è”ç½‘åŠ è½½CDNèµ„æºã€‚

## ğŸ“Š ç‰ˆæœ¬æ›´æ–°å†å²

### v2.0(æœ€æ–°)
- **å¢å¼ºé…ç½®ç®¡ç†å™¨**ï¼šä¸ºæ¯ä¸ªUUIDæä¾›ä¸“å±è®¿é—®ç»Ÿè®¡å›¾è¡¨
- **æ–°å¢å®æ—¶è¶‹åŠ¿åˆ†æ**ï¼šåœ¨é…ç½®ç®¡ç†é¡µé¢å±•ç¤ºè®¿é—®è¶‹åŠ¿æŠ˜çº¿å›¾
- **å¢åŠ è®¿é—®è®°å½•åŠŸèƒ½**ï¼šæ˜¾ç¤ºæœ€è¿‘è®¿é—®è®°å½•å’Œå®¢æˆ·ç«¯ä¿¡æ¯
- **ä¼˜åŒ–ç”¨æˆ·ä½“éªŒ**ï¼šæ›´ç›´è§‚çš„æ•°æ®å±•ç¤ºå’Œäº¤äº’å¼å›¾è¡¨
- **æ‰©å±•ç»Ÿè®¡æ¥å£**ï¼šæä¾›æ›´çµæ´»çš„ç»Ÿè®¡æŸ¥è¯¢é€‰é¡¹
- **æ—¥å¿—è®°å½•**ï¼šæ–°å¢è®¿é—®æ—¥å¿—è®°å½•åŠŸèƒ½

### v1.4
- æ–°å¢MFAåŒé‡éªŒè¯åŠŸèƒ½
- æ”¯æŒTOTPéªŒè¯å’Œå¤‡ä»½ç ç™»å½•
- å¢å¼ºç³»ç»Ÿå®‰å…¨æ€§

### v1.3
- æ–°å¢è‡ªåŠ¨æ›´æ–°IPæ± åŠŸèƒ½
- æ”¯æŒå¤šä¸ªIPæ•°æ®æºé…ç½®
- æ·»åŠ è‡ªåŠ¨æ›´æ–°ç®¡ç†ç•Œé¢

### v1.2
- æ–°å¢é…ç½®ç®¡ç†é¡µé¢
- æ”¯æŒé…ç½®CRUDæ“ä½œ
- æ·»åŠ åŸŸåç®¡ç†åŠŸèƒ½
- æ”¹è¿›è®¢é˜…é“¾æ¥æ˜¾ç¤º

### v1.1
- åˆå§‹ç¨³å®šç‰ˆæœ¬
- æ”¯æŒIP/åŸŸåä¼˜é€‰æ›¿æ¢
- æä¾›è®¢é˜…æ¥å£
- åŸºç¡€ç®¡ç†åŠŸèƒ½

## ğŸ¯ é€‚ç”¨åœºæ™¯

1. **ä»£ç†é…ç½®æ‰¹é‡ç®¡ç†**ï¼šé€‚åˆç®¡ç†å¤šä¸ªä»£ç†é…ç½®ï¼Œé¿å…é‡å¤ä¿®æ”¹
2. **IPä¼˜é€‰æœåŠ¡**ï¼šä¸ºä»£ç†æä¾›ä¼˜åŒ–çš„Cloudflare IPå’ŒåŸŸå
3. **è®¢é˜…æœåŠ¡åˆ†å‘**ï¼šé€šè¿‡UUIDåˆ†ç»„ä¸ºä¸åŒç”¨æˆ·æä¾›å®šåˆ¶è®¢é˜…
4. **ä½¿ç”¨æƒ…å†µåˆ†æ**ï¼šé€šè¿‡ç»Ÿè®¡åˆ†æäº†è§£é…ç½®çš„ä½¿ç”¨æƒ…å†µå’Œçƒ­åº¦
5. **å¤šç®¡ç†å‘˜åä½œ**ï¼šæ”¯æŒå¤šç®¡ç†å‘˜é€šè¿‡JWTè®¤è¯ç®¡ç†é…ç½®

## ğŸ”§ æŠ€æœ¯æ ˆ

- **è¿è¡Œç¯å¢ƒ**: Cloudflare Workers (æ— æœåŠ¡å™¨è¾¹ç¼˜è®¡ç®—)
- **æ•°æ®åº“**: Cloudflare D1 (åŸºäºSQLiteçš„åˆ†å¸ƒå¼æ•°æ®åº“)
- **å‰ç«¯æ¡†æ¶**: çº¯HTML/CSS/JavaScriptï¼Œæ— æ¡†æ¶ä¾èµ–
- **å›¾è¡¨åº“**: Chart.js (ç”¨äºæ•°æ®å¯è§†åŒ–)
- **è®¤è¯ç³»ç»Ÿ**: JWT + TOTPåŒé‡éªŒè¯
- **é€šè®¯åè®®**: æ”¯æŒVMessã€VLESSã€Trojanåè®®

---

**å…è´£å£°æ˜**ï¼šæœ¬å·¥å…·ä»…ä¾›å­¦ä¹ å’Œç ”ç©¶ä½¿ç”¨ï¼Œè¯·éµå®ˆå½“åœ°æ³•å¾‹æ³•è§„ï¼Œä¸å¾—ç”¨äºéæ³•ç”¨é€”ã€‚ä½œè€…ä¸æ‰¿æ‹…ä»»ä½•ä½¿ç”¨æœ¬å·¥å…·äº§ç”Ÿçš„æ³•å¾‹è´£ä»»ã€‚
