# ä»£ç†é…ç½®ç®¡ç†ä¼˜é€‰å·¥å…· 

![JavaScript](https://img.shields.io/badge/JavaScript-ES6+-yellow?logo=javascript&logoColor=white) ![Cloudflare Workers](https://img.shields.io/badge/Cloudflare-Workers-F38020?logo=cloudflare&logoColor=white)![D1 Database](https://img.shields.io/badge/Cloudflare-D1-0052CC?logo=cloudflare&logoColor=white)  ![MIT License](https://img.shields.io/badge/License-MIT-green.svg) ![Node.js](https://img.shields.io/badge/Node.js-18+-339933?logo=node.js&logoColor=white)  ![Chart.js](https://img.shields.io/badge/Chart.js-4.0+-FF6384?logo=chart.js&logoColor=white) ![Version](https://img.shields.io/badge/Versionâˆ’3.0-blue.svg)

è¿™æ˜¯ä¸€ä¸ªè¿è¡Œåœ¨ Cloudflare Worker ä¸Šçš„å¤šåŠŸèƒ½ä»£ç†å·¥å…·ï¼Œç»“åˆ Cloudflare D1 æ•°æ®åº“ï¼Œæä¾›**IPä¼˜é€‰**å’Œ**åŸŸåä¼˜é€‰**çš„æ‰¹é‡æ›¿æ¢åŠŸèƒ½ã€‚ç³»ç»Ÿé‡‡ç”¨ä¸‰ Worker æ¶æ„ï¼Œåˆ†åˆ«å¤„ç†ä¼˜é€‰ç”Ÿæˆã€é…ç½®ç®¡ç†å’Œç³»ç»Ÿç®¡ç†ï¼Œå®ç°åŠŸèƒ½è§£è€¦å’Œç‹¬ç«‹éƒ¨ç½²ã€‚

## ğŸ“¦ ç³»ç»Ÿç»„æˆ

**ç³»ç»Ÿç”±3ä¸ªæ ¸å¿ƒWorkerç»„æˆ**ï¼š

- **`worker.js`** - ä¼˜é€‰ç”Ÿæˆå™¨ï¼šå¤„ç† IP/åŸŸåä¼˜é€‰ã€è®¢é˜…ç”Ÿæˆã€æ‰¹é‡é…ç½®æ›¿æ¢ã€è®¿é—®æ—¥å¿—è®°å½•
- **`config_worker.js`** - é…ç½®ç®¡ç†å™¨ï¼šæä¾›é…ç½® CRUD æ“ä½œã€è®¢é˜…æ¥å£ã€é…ç½®ç¼–è¾‘åŠŸèƒ½ã€UUIDè®¿é—®ç»Ÿè®¡
- **`mg_worker.js`** - ç®¡ç†åå°ï¼šJWT è®¤è¯ã€åŸŸå/IP/UUID ç®¡ç†ã€ç³»ç»Ÿç»Ÿè®¡ã€æ‰‹åŠ¨ IP æ›´æ–°ã€è®¢é˜…è®¿é—®ç»Ÿè®¡åˆ†æï¼ˆå·²é›†æˆIPæ›´æ–°åŠŸèƒ½ï¼‰

## âœ¨ ä¸»è¦ç‰¹æ€§

### 1. **ä¸‰ Worker å¾®æœåŠ¡æ¶æ„**

è¯¥ç³»ç»Ÿé‡‡ç”¨ä¸‰ Worker æ¶æ„ï¼Œå„å¸å…¶èŒï¼š

*   **`worker.js`** - ä¼˜é€‰ç”Ÿæˆå™¨ï¼šå¤„ç† IP/åŸŸåä¼˜é€‰ã€è®¢é˜…ç”Ÿæˆã€æ‰¹é‡é…ç½®æ›¿æ¢ã€è®¿é—®æ—¥å¿—è®°å½•
*   **`config_worker.js`** - é…ç½®ç®¡ç†å™¨ï¼šæä¾›é…ç½® CRUD æ“ä½œã€è®¢é˜…æ¥å£ã€é…ç½®ç¼–è¾‘åŠŸèƒ½ï¼ŒåŒ…å«å¤–éƒ¨é…ç½®ç”Ÿæˆå™¨é“¾æ¥å’ŒUUIDè®¿é—®ç»Ÿè®¡
*   **`mg_worker.js`** - ç®¡ç†åå°ï¼šJWT è®¤è¯ã€åŸŸå/IP/UUID ç®¡ç†ã€ç³»ç»Ÿç»Ÿè®¡ã€IPæ›´æ–°åŠŸèƒ½ã€è®¢é˜…è®¿é—®ç»Ÿè®¡åˆ†æï¼ˆå·²åˆå¹¶IPæ›´æ–°åŠŸèƒ½ï¼‰

### 2. **åŸŸåæ‰˜ç®¡å±æ€§ç®¡ç† [v2.2.0æ›´æ–°]**

*   **æ‰©å±•åŸŸåæ‰˜ç®¡ç±»å‹**ï¼šæ–°å¢æ”¯æŒå¤šç§CDNå‚å•†ï¼ŒåŒ…æ‹¬ Gcoreã€Fastlyã€CacheFlyã€LightCDNã€Vercelã€Netlify ç­‰
*   **å¢åŠ "æ— "é€‰é¡¹**ï¼šæ”¯æŒæ ‡è®°é…ç½®ä¸ºä¸ä½¿ç”¨åŸŸåæ‰˜ç®¡çš„æƒ…å†µ
*   **æ™ºèƒ½ä¼˜é€‰åŒ¹é…**ï¼šä¼˜é€‰é…ç½®ç”Ÿæˆå™¨ç°åœ¨ä¼šæ ¹æ®åŸŸåæ‰˜ç®¡å±æ€§æ™ºèƒ½å¤„ç†é…ç½®
    *   **Cloudflareå±æ€§é…ç½®**ï¼šä¼šè¿›è¡Œä¼˜é€‰æ›¿æ¢ï¼ˆè¾“å‡ºåŸé…ç½® + ä¼˜é€‰é…ç½®ï¼‰
    *   **éCloudflareå±æ€§é…ç½®**ï¼šåªè¾“å‡ºåŸé…ç½®ï¼Œä¸è¿›è¡Œä¼˜é€‰æ›¿æ¢
    *   **æ‰€æœ‰é…ç½®éƒ½è¾“å‡º**ï¼šæ— è®ºåŸŸåå±æ€§å¦‚ä½•ï¼Œéƒ½ä¼šè¾“å‡ºåŸé…ç½®
*   **å½©è‰²å¾½ç« æ ‡è¯†**ï¼šå‰ç«¯ç•Œé¢ä¸ºä¸åŒåŸŸåæ‰˜ç®¡ç±»å‹æ˜¾ç¤ºå½©è‰²å¾½ç« ï¼Œä¾¿äºè¯†åˆ«
*   **ç»Ÿä¸€åˆ†ç±»ç®¡ç†**ï¼šå¸®åŠ©ç”¨æˆ·æŒ‰CDNå‚å•†åˆ†ç±»ç®¡ç†é…ç½®

### 3. **åè®®æ”¯æŒæ‰©å±• [v2.1.1æ›´æ–°]**

*   **æ‰©å±•åè®®æ”¯æŒ**ï¼šåœ¨åŸæœ‰ VMessã€VLESSã€Trojan åè®®åŸºç¡€ä¸Šï¼Œå¢åŠ å¯¹æ›´å¤šä¸»æµä»£ç†åè®®çš„æ”¯æŒï¼ŒåŒ…æ‹¬ Shadowsocks (ss)ã€ShadowsocksR (ssr) ç­‰
*   **ç»Ÿä¸€è§£ææ¶æ„**ï¼šæ‰€æœ‰åè®®éƒ½é›†æˆåˆ°ç»Ÿä¸€çš„è§£æå™¨ä¸­ï¼Œæ”¯æŒæ ‡å‡†æ ¼å¼çš„åè®®é“¾æ¥
*   **å‘ä¸‹å…¼å®¹**ï¼šåŸæœ‰åè®®é…ç½®ä¿æŒå®Œå…¨å…¼å®¹ï¼Œæ–°åè®®å¯æ— ç¼é›†æˆåˆ°é…ç½®ç®¡ç†ç³»ç»Ÿ

### 4. **åŒæ¨¡å¼ä¼˜é€‰**

*   æ”¯æŒå°†é…ç½®ä¸­çš„åœ°å€æ‰¹é‡æ›¿æ¢ä¸º **ä¼˜é€‰ IP** æˆ– **ä¼˜é€‰åŸŸå**
*   **æ”¯æŒ IPv4/IPv6** å’Œä¸åŒè¿è¥å•†ï¼ˆç”µä¿¡/è”é€š/ç§»åŠ¨ï¼‰ç­›é€‰
*   **IP èµ„æºæ± å¢åŠ äº† IP æ¥æºæ˜¾ç¤º**ï¼ˆå¦‚ï¼šHostMonit IPv4, HostMonit IPv6, Vps789ï¼‰
*   æ”¯æŒé€šè¿‡ç®¡ç†åå°æ‰‹åŠ¨æ›´æ–° IP æ•°æ®æºï¼ˆç›´æ¥è°ƒç”¨mg_worker.jså†…ç½®çš„IPæ›´æ–°åŠŸèƒ½ï¼‰

### 5. **é…ç½®ç®¡ç† (CRUD) [v1.2]**

*   æä¾›å®Œæ•´çš„ç®¡ç†ç•Œé¢ï¼Œå¯æ·»åŠ ã€æŸ¥è¯¢ã€ç¼–è¾‘ã€åˆ é™¤åŸºç¡€é…ç½®ï¼ˆæ”¯æŒ VMess, VLESS, Trojan, Shadowsocks ç­‰ï¼‰
*   æŒ‰ UUID åˆ†ç»„ç®¡ç†ï¼Œæ–¹ä¾¿ç”Ÿæˆä¸åŒçš„è®¢é˜…
*   æ”¯æŒé…ç½®ç¼–è¾‘åŠŸèƒ½ï¼Œå¯ä¿®æ”¹åˆ«åã€åœ°å€ã€ç«¯å£ã€ä¼ è¾“åè®®ç­‰å‚æ•°
*   **ç¼–è¾‘é…ç½®å³æ—¶è¿”å› [v2.1.1æ›´æ–°]**ï¼šä¿®æ”¹é…ç½®åï¼ŒAPIæ¥å£ä¼šç«‹å³è¿”å›æ›´æ–°åçš„å®Œæ•´é…ç½®å¯¹è±¡ï¼Œå‰ç«¯æ— éœ€é‡æ–°æŸ¥è¯¢å³å¯æ›´æ–°ç•Œé¢æ˜¾ç¤º
*   æä¾›é…ç½®ç”Ÿæˆå™¨å¤–éƒ¨é“¾æ¥ï¼ˆ"é…ç½®ç”Ÿæˆ"æŒ‰é’®ï¼‰ï¼Œé“¾æ¥åˆ°å¤–éƒ¨é…ç½®ç”Ÿæˆå™¨ï¼ˆhttps://cfst.yangzifun.orgï¼‰
*   æ”¹è¿›çš„è®¢é˜…é“¾æ¥æ˜¾ç¤ºæ–¹å¼ï¼ˆä½¿ç”¨å¯å¤åˆ¶çš„è¾“å…¥æ¡†ï¼‰
*   ç»Ÿä¸€çš„å‰ç«¯æŒ‰é’®æ ·å¼

### 6. **åŠ¨æ€è®¢é˜…ç”Ÿæˆ**

*   æä¾› `/sub/{uuid}` è®¢é˜…æ¥å£ï¼Œè¿”å› Base64 ç¼–ç çš„é…ç½®åˆ—è¡¨
*   æ”¯æŒé€šè¿‡ URL å‚æ•°åŠ¨æ€æŒ‡å®š IP ç±»å‹ï¼ˆIPv4/IPv6ï¼‰æˆ–è¿è¥å•†ï¼ˆç”µä¿¡/è”é€š/ç§»åŠ¨ï¼‰
*   æ”¯æŒæ‰¹é‡æ·»åŠ é…ç½®ï¼Œæé«˜ç®¡ç†æ•ˆç‡

### 7. **è®¿é—®æ—¥å¿—è®°å½• [v2.0æ–°å¢]**

*   **å®Œæ•´çš„è®¿é—®ç»Ÿè®¡**ï¼šè®°å½•ç”¨æˆ·é€šè¿‡UUIDç”Ÿæˆé…ç½®çš„æ‰€æœ‰è®¿é—®
*   **åŒæ¨¡å¼è®°å½•**ï¼š
    - è®¢é˜…é“¾æ¥è®¿é—® (`subscription`)
    - ç½‘é¡µAPIç”Ÿæˆè®¿é—® (`api-generation`)
*   **å®¢æˆ·ç«¯ä¿¡æ¯æ”¶é›†**ï¼šè®°å½•å®¢æˆ·ç«¯IPã€User-Agent
*   **å®æ—¶ç»Ÿè®¡API**ï¼šæä¾›`/stats`æ¥å£è·å–è¯¦ç»†çš„è®¿é—®ç»Ÿè®¡æ•°æ®
*   **æ±‡æ€»åˆ†æ**ï¼šæ”¯æŒæŒ‰æ—¥æœŸã€UUIDã€è®¿é—®ç±»å‹è¿›è¡Œå¤šç»´åº¦ç»Ÿè®¡

### 8. **è®¢é˜…åˆ†æåŠŸèƒ½ [v2.0æ–°å¢]**

*   **ç®¡ç†åå°è®¢é˜…åˆ†æ**ï¼šåœ¨ç®¡ç†åå°æä¾›å…¨å±€è®¿é—®åˆ†æ
*   **é…ç½®é¡µé¢UUIDç»Ÿè®¡**ï¼šåœ¨é…ç½®ç®¡ç†é¡µé¢ä¸ºæ¯ä¸ªUUIDæä¾›ä¸“å±ç»Ÿè®¡å›¾è¡¨
*   **äº¤äº’å¼è¶‹åŠ¿å›¾è¡¨**ï¼šä½¿ç”¨Chart.jså¯è§†åŒ–è¿‘7/14/30/60å¤©çš„è®¿é—®è¶‹åŠ¿
*   **å¤šç»´åº¦åˆ†æ**ï¼š
    - æ€»è®¿é—®é‡è¶‹åŠ¿
    - è®¢é˜…è®¿é—® vs ç½‘é¡µç”Ÿæˆè®¿é—®å¯¹æ¯”
*   **å®æ—¶æ•°æ®æ›´æ–°**ï¼šæ”¯æŒæ‰‹åŠ¨åˆ·æ–°ç»Ÿè®¡æ•°æ®
*   **è¯¦ç»†è®¿é—®è®°å½•**ï¼šæ˜¾ç¤ºæœ€è¿‘è®¿é—®è®°å½•å’Œå®¢æˆ·ç«¯ä¿¡æ¯

### 9. **å®Œæ•´çš„æ•°æ®ç®¡ç†**

*   åŸŸåç®¡ç†ï¼šæ·»åŠ ã€ç¼–è¾‘ã€åˆ é™¤ä¼˜é€‰åŸŸå
*   **IP èµ„æºæ± ç®¡ç†**ï¼šæŸ¥çœ‹ã€åˆ é™¤ã€åˆ·æ–°ä¼˜é€‰ IPï¼Œ**æ”¯æŒ HostMonit IPv6 æ¥å£å¼€å¯/å…³é—­ï¼Œå¹¶æ˜¾ç¤º IP æ¥æº**
*   UUID åˆ†ç»„ç®¡ç†ï¼šæŒ‰ UUID ç®¡ç†é…ç½®åˆ†ç»„
*   ç³»ç»Ÿç»Ÿè®¡ï¼šå®æ—¶æŸ¥çœ‹åŸŸåã€IPã€UUID æ•°é‡ç»Ÿè®¡
*   **IPæ›´æ–°åŠŸèƒ½é›†æˆ**ï¼šIPæ›´æ–°ä»»åŠ¡å·²é›†æˆåˆ°mg_worker.jsä¸­ï¼Œæ— éœ€ç‹¬ç«‹çš„IP Worker

### 10. **IPèµ„æºæ± æ™ºèƒ½ç®¡ç† [v2.1æ–°å¢]**

*   **æ”¯æŒä¸€ä¸ªIPå¤šä¸ªè¿è¥å•†**ï¼šåŒä¸€ä¸ªIPå¯ä»¥å…³è”å¤šä¸ªè¿è¥å•†ï¼ˆå¦‚CMã€CTã€CUç­‰ï¼‰
*   **åŸºäºIP+è¿è¥å•†ç»„åˆå»é‡**ï¼šä½¿ç”¨IPåœ°å€å’Œè¿è¥å•†ç»„åˆä½œä¸ºå”¯ä¸€æ ‡è¯†ï¼Œæ”¯æŒæ›´ç²¾ç»†çš„IPç®¡ç†
*   **å¢é‡æ›´æ–°æœºåˆ¶**ï¼šåªæ’å…¥æ–°è®°å½•ã€æ›´æ–°æ¥æºä¿¡æ¯ï¼Œæ™ºèƒ½åˆ é™¤é•¿æ—¶é—´ä¸å­˜åœ¨çš„è®°å½•
*   **è¯¦ç»†çš„ç»Ÿè®¡ä¿¡æ¯**ï¼šæä¾›IPæ¥æºåˆ†å¸ƒã€è¿è¥å•†ç»Ÿè®¡ã€IPç±»å‹åˆ†å¸ƒç­‰å¤šç»´åº¦åˆ†æ
*   **å®šæ—¶æ›´æ–°ä»»åŠ¡**ï¼šæ”¯æŒé€šè¿‡Cloudflare Workersçš„Cron Triggersè‡ªåŠ¨æ›´æ–°IPèµ„æºæ± 
*   **æ‰‹åŠ¨æ›´æ–°æ¥å£**ï¼šæä¾›å…¬å¼€çš„æ‰‹åŠ¨æ›´æ–°æ¥å£ï¼Œæ— éœ€è®¤è¯å³å¯è§¦å‘IPæ›´æ–°
*   **æ¥æºè¿½è¸ª**ï¼šè®°å½•æ¯ä¸ªIPçš„å…·ä½“æ¥æºï¼ˆHostMonit IPv4/IPv6ã€Vps789ç­‰ï¼‰

### 11. **é…ç½®ç¼–è¾‘å™¨é«˜çº§åŠŸèƒ½**

*   **å¤šåè®®é…ç½®è§£æå™¨**ï¼šæ”¯æŒVMessã€VLESSã€Trojanã€Shadowsocksç­‰å¤šç§åè®®çš„è¯¦ç»†å‚æ•°ç¼–è¾‘
*   **åŸŸåæ‰˜ç®¡å±æ€§ç¼–è¾‘**ï¼šå¯ç›´æ¥åœ¨ç¼–è¾‘å™¨ä¸­ä¿®æ”¹é…ç½®çš„åŸŸåæ‰˜ç®¡å±æ€§ï¼ˆCloudflareã€é˜¿é‡ŒESAã€è…¾è®¯Edgeoneç­‰ï¼‰
*   **å‚æ•°éªŒè¯**ï¼šè‡ªåŠ¨éªŒè¯ç«¯å£ã€UUIDã€ä¼ è¾“åè®®ç­‰å‚æ•°çš„åˆæ³•æ€§
*   **å³æ—¶é¢„è§ˆ**ï¼šä¿å­˜åç«‹å³åœ¨é…ç½®åˆ—è¡¨ä¸­æ˜¾ç¤ºæ›´æ–°åçš„é…ç½®å†…å®¹ï¼Œæ— éœ€é‡æ–°æŸ¥è¯¢
*   **ç»Ÿä¸€ç¼–è¾‘ç•Œé¢**ï¼šæ‰€æœ‰åè®®ç±»å‹ä½¿ç”¨ç»Ÿä¸€çš„ç¼–è¾‘ç•Œé¢ï¼Œç®€åŒ–æ“ä½œæµç¨‹

### 12. **å®‰å…¨ç‰¹æ€§**

*   JWT è®¤è¯ç³»ç»Ÿï¼Œä¿éšœç®¡ç†åå°å®‰å…¨
*   **MFAåŒé‡éªŒè¯ [v1.4æ–°å¢]**ï¼š
    - æ”¯æŒTOTP(åŸºäºæ—¶é—´çš„ä¸€æ¬¡æ€§å¯†ç )éªŒè¯
    - ç®¡ç†å‘˜å¯å¯ç”¨/ç¦ç”¨MFA
    - æä¾›10ä¸ªä¸€æ¬¡æ€§å¤‡ä»½ç ï¼Œé˜²æ­¢éªŒè¯å™¨ä¸¢å¤±
    - æ”¯æŒä½¿ç”¨å¤‡ä»½ç ç™»å½•
*   å“åº”å¼è®¾è®¡ï¼Œé€‚é…æ¡Œé¢å’Œç§»åŠ¨è®¾å¤‡
*   é…ç½®ç”Ÿæˆå™¨å¤–éƒ¨é“¾æ¥è·³è½¬åŠŸèƒ½ï¼Œæä¾›ä¸€ç«™å¼é…ç½®ç®¡ç†ä½“éªŒ

## ğŸ› ï¸ éƒ¨ç½²å‡†å¤‡

åœ¨ä½¿ç”¨æ­¤è„šæœ¬ä¹‹å‰ï¼Œæ‚¨éœ€è¦ï¼š

1.  ä¸€ä¸ª **Cloudflare** è´¦å·ã€‚
2.  å¯ç”¨ **Workers** å’Œ **D1 Database** åŠŸèƒ½ã€‚
3.  è‡³å°‘ä¸€ä¸ªè‡ªå®šä¹‰åŸŸåï¼ˆç”¨äºéƒ¨ç½²ä¸‰ä¸ªWorkerï¼‰ã€‚

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### 1. åˆ›å»º D1 æ•°æ®åº“

åœ¨ Cloudflare æ§åˆ¶å°çš„ "Workers & Pages" -> "D1" ä¸­åˆ›å»ºä¸€ä¸ªæ–°çš„æ•°æ®åº“ï¼ˆä¾‹å¦‚å‘½åä¸º `proxy-db`ï¼‰ã€‚

### 2. åˆå§‹åŒ–æ•°æ®åº“è¡¨å•ä¸ç¨‹åºå¯¹åº”å…³ç³»

è¿›å…¥ D1 æ•°æ®åº“çš„ "Console" æ ‡ç­¾é¡µï¼Œæ‰§è¡Œ `init_database.sql` ä¸­ SQL è¯­å¥ä»¥åˆ›å»ºæ‰€éœ€çš„è¡¨ç»“æ„ã€‚ä¸‹é¢æ˜¯æ•°æ®åº“è¡¨å•ä¸å„ Worker ç¨‹åºçš„å¯¹åº”å…³ç³»ï¼š

| è¡¨å•åç§° | ç”¨é€”æè¿° | ä½¿ç”¨æ­¤è¡¨å•çš„ç¨‹åº | æ˜¯å¦å¿…éœ€ | ä½¿ç”¨çŠ¶æ€ |
|---------|---------|----------------|---------|----------|
| **configs** | å­˜å‚¨ä»£ç†é…ç½®æ•°æ®ï¼ŒåŒ…æ‹¬åŸŸåæ‰˜ç®¡å±æ€§ | `worker.js`, `config_worker.js`, `mg_worker.js` | **å¿…éœ€** | **å·²ä½¿ç”¨** |
| **config_access_logs** | è®°å½•é…ç½®è®¿é—®æ—¥å¿—ï¼Œç”¨äºç»Ÿè®¡åˆ†æ | `worker.js`, `config_worker.js`, `mg_worker.js` | **å¿…éœ€** | **å·²ä½¿ç”¨** |
| **admin_users** | å­˜å‚¨ç®¡ç†å‘˜è´¦æˆ·ä¿¡æ¯ï¼Œæ”¯æŒ MFA åŒé‡éªŒè¯ | `mg_worker.js` | **å¿…éœ€** | **å·²ä½¿ç”¨** |
| **cfips** | å­˜å‚¨ä¼˜é€‰ IP åœ°å€ï¼Œæ”¯æŒä¸€ä¸ª IP å¤šä¸ªè¿è¥å•† | `worker.js`, `mg_worker.js` | **å¿…éœ€** | **å·²ä½¿ç”¨** |
| **cf_domains** | å­˜å‚¨ä¼˜é€‰åŸŸååˆ—è¡¨ | `worker.js`, `mg_worker.js` | **å¿…éœ€** | **å·²ä½¿ç”¨** |
| **auto_update_settings** | å­˜å‚¨è‡ªåŠ¨æ›´æ–°é…ç½®è®¾ç½® | `mg_worker.js` | **å¿…éœ€** | **å·²ä½¿ç”¨** |
| **mfa_backup_codes** | å­˜å‚¨ MFA å¤‡ä»½ç  | `mg_worker.js` | **å¿…éœ€** | **å·²ä½¿ç”¨** |

**è¯´æ˜ï¼š**
- **å¿…éœ€è¡¨å•**ï¼šç³»ç»Ÿæ­£å¸¸è¿è¡Œå¿…é¡»çš„è¡¨å•ï¼Œæ‰€æœ‰ Worker ç¨‹åºéƒ½ä¼šç”¨åˆ°
- **å·²ä½¿ç”¨è¡¨å•**ï¼šåœ¨å½“å‰ä»£ç ä¸­æœ‰å®é™…è¯»å†™æ“ä½œçš„è¡¨å•
- **å·²ç§»é™¤è¡¨å•**ï¼š`users`, `uuids`, `system_logs`, `api_access_stats` ç­‰æœªä½¿ç”¨çš„è¡¨å·²ä»æ•°æ®åº“æ–‡ä»¶ä¸­ç§»é™¤
- **ç¨‹åºä¾èµ–å…³ç³»**ï¼š
  - `worker.js`ï¼šè¯»å– `configs`, `cfips`, `cf_domains`ï¼Œå†™å…¥ `config_access_logs`
  - `config_worker.js`ï¼šè¯»å†™ `configs`ï¼Œè¯»å– `config_access_logs`
  - `mg_worker.js`ï¼šè¯»å†™ `admin_users`, `cf_domains`, `cfips`, `auto_update_settings`, `mfa_backup_codes`ï¼Œè¯»å– `configs`, `config_access_logs`

è¦åˆå§‹åŒ–æ•°æ®åº“ï¼Œè¯·å¤åˆ¶ `init_database.sql` ä¸­çš„å®Œæ•´ SQL è¯­å¥åˆ° D1 Console ä¸­æ‰§è¡Œï¼š



### 3. åˆ›å»ºä¸‰ä¸ªWorkerå¹¶ç»‘å®šD1

åˆ›å»ºä¸‰ä¸ªWorkerå¹¶ç»‘å®šåˆ°åŒä¸€ä¸ªD1æ•°æ®åº“ï¼š

| Workeråç§°     | ç»‘å®šæ–‡ä»¶           | æ•°æ®åº“ç»‘å®šå˜é‡ | å»ºè®®è·¯ç”±/åŸŸå                   |
| -------------- | ------------------ | -------------- | ------------------------------- |
| `proxy-main`   | `worker.js`        | `DB`           | `cfst.yangzifun.org*`       |
| `proxy-config` | `config_worker.js` | `DB`           | `config.proxypilot.yangzifun.org` |
| `proxy-mg`     | `mg_worker.js`     | `DB`           | `mg.proxypilot.yangzifun.org`         |

ç»‘å®šæ­¥éª¤ï¼š

1.  æ¯ä¸ªWorkerçš„"Settings" â†’ "Variables"ä¸­æ·»åŠ D1ç»‘å®š
2.  **Variable name** å¿…é¡»è®¾ç½®ä¸º `DB`ï¼ˆåŒºåˆ†å¤§å°å†™ï¼‰
3.  é€‰æ‹©å‰é¢åˆ›å»ºçš„D1æ•°æ®åº“
4.  **è·¯ç”±é…ç½®**ï¼š
    *   åœ¨ DNS è®¾ç½®ä¸­åˆ›å»ºä¸‰æ¡è·¯ç”±ï¼ˆç¤ºä¾‹ï¼Œè¯·æ›¿æ¢ä¸ºæ‚¨çš„å®é™…åŸŸåï¼‰
5.  **é‡è¦é…ç½®**ï¼šè¿›å…¥æ¯ä¸ª Worker çš„ **Settings** -> **Variables**ï¼š
    *   **D1 Database Bindings**ï¼š
        *   **Variable name**: `DB` (å¿…é¡»å®Œå…¨ä¸€è‡´ï¼Œæ³¨æ„å¤§å†™)
        *   **D1 database**: é€‰æ‹©ç¬¬ 1 æ­¥åˆ›å»ºçš„æ•°æ®åº“ã€‚
    *   **JWT å¯†é’¥**ï¼ˆä»…é™ `mg_worker.js`ï¼‰ï¼š
        *   **Variable name**: `JWT_SECRET` (å¿…é¡»å®Œå…¨ä¸€è‡´)
        *   **Value**: è¯·è®¾ç½®ä¸€ä¸ªè¶³å¤Ÿé•¿ä¸”å¤æ‚çš„éšæœºå­—ç¬¦ä¸²ä½œä¸º JWT å¯†é’¥ï¼Œç”¨äºç­¾åå’ŒéªŒè¯ç®¡ç†åå°çš„è®¤è¯ Tokenã€‚ä¾‹å¦‚ï¼Œå¯ä»¥ä½¿ç”¨ `openssl rand -base64 32` ç”Ÿæˆã€‚

### 4. åˆå§‹åŒ–åŸŸåè¡¨ (å¯é€‰)

åœ¨é…ç½®ç®¡ç†é¡µ(`mg.example.com`)ä¸Šçº¿åï¼Œæ‚¨å¯ä»¥ç›´æ¥åœ¨UIä¸­æ·»åŠ åŸŸåï¼š

1.  è®¿é—®ç®¡ç†åå°åœ°å€ (`mg.example.com`) å¹¶ç™»å½•ã€‚
2.  åˆ‡æ¢åˆ° "ä¼˜é€‰åŸŸå" æ ‡ç­¾é¡µã€‚
3.  ç‚¹å‡» "æ·»åŠ åŸŸå" æŒ‰é’®ã€‚
4.  è¾“å…¥åŸŸåå’Œå¤‡æ³¨ä¿¡æ¯ã€‚

æˆ–è€…é€šè¿‡ SQL åˆå§‹åŒ–ï¼ˆåœ¨ D1 Console ä¸­æ‰§è¡Œï¼‰ï¼š

```sql
INSERT INTO cf_domains (domain, remark, created_at) VALUES 
('cf.example.com', 'é»˜è®¤ä¼˜é€‰åŸŸå', unixepoch()),
('cdn.example.net', 'åŠ é€ŸCDNä¸“ç”¨', unixepoch());
```

### 5. éƒ¨ç½²ä¸Šçº¿

ç‚¹å‡» "Deploy" ä¿å­˜å¹¶å‘å¸ƒæ‰€æœ‰Workerã€‚è®¿é—®å„ Worker çš„ URL å³å¯çœ‹åˆ°æ“ä½œç•Œé¢ã€‚

---

## ğŸ“– ä½¿ç”¨æŒ‡å—

### 1. é¦–é¡µ (æ‰¹é‡ç”Ÿæˆå™¨)

*   **åŸºç¡€é…ç½®**ï¼š
    *   **æ‰‹åŠ¨ç²˜è´´**ï¼šç›´æ¥å°† vmess/vless/trojan/ss/ssr ç­‰é“¾æ¥ç²˜è´´åˆ°æ–‡æœ¬æ¡†ã€‚
    *   **ä» UUID è·å–**ï¼šè¾“å…¥åœ¨ç®¡ç†é¡µä¿å­˜çš„ UUIDï¼Œè„šæœ¬ä¼šè‡ªåŠ¨æ‹‰å–è¯¥ç»„æ‰€æœ‰é…ç½®ã€‚
*   **ä¼˜é€‰åˆ—è¡¨**ï¼š
    *   **IP åœ°å€**ï¼šé€‰æ‹© IPv4/IPv6 æˆ–ç‰¹å®šè¿è¥å•†ã€‚æ”¯æŒ HostMonit IPv4/IPv6 åŠ Vps789 ç­‰å¤šä¸ªæ¥æºçš„ IP æ•°æ®ã€‚å¦‚æœ IP æ± ä¸ºç©ºï¼Œè¯·åœ¨ç®¡ç†åå°çš„ **"IP èµ„æºæ± ç®¡ç†"** ä¸­ï¼Œç‚¹å‡» **"ç«‹å³æ›´æ–°"** æŒ‰é’®æ‰‹åŠ¨è·å– IPã€‚
    *   **ä¼˜é€‰åŸŸå**ï¼šç›´æ¥ä½¿ç”¨æ•°æ®åº“ `cf_domains` è¡¨ä¸­çš„åŸŸåã€‚
*   **ç”Ÿæˆé…ç½®**ï¼šç‚¹å‡»æŒ‰é’®ï¼Œåº•éƒ¨æ–‡æœ¬æ¡†å°†æ˜¾ç¤ºæ›¿æ¢åçš„èŠ‚ç‚¹åˆ—è¡¨ã€‚
*   **è®¿é—®æ—¥å¿—**ï¼šä½¿ç”¨UUIDç”Ÿæˆé…ç½®ä¼šè‡ªåŠ¨è®°å½•è®¿é—®æ—¥å¿—ï¼Œç”¨äºåå°ç»Ÿè®¡ã€‚
*   **åŸŸåæ‰˜ç®¡å±æ€§è¿‡æ»¤**ï¼šåªæœ‰åŸŸåæ‰˜ç®¡å±æ€§ä¸º"Cloudflare"çš„é…ç½®ä¼šè¿›è¡Œä¼˜é€‰æ›¿æ¢ï¼ŒéCloudflareé…ç½®åªè¾“å‡ºåŸé…ç½®ã€‚

### 2. é…ç½®ç®¡ç†é¡µ (`config.example.com`)

*   åœ¨æ­¤é¡µé¢ï¼Œæ‚¨å¯ä»¥ï¼š
    *   **ç®¡ç†åŸºç¡€é…ç½®**ï¼šæ·»åŠ /æŸ¥è¯¢/åˆ é™¤èŠ‚ç‚¹é…ç½®ï¼ˆ**v2.2.0æ–°å¢æ›´å¤šåŸŸåæ‰˜ç®¡å±æ€§**ï¼‰
    *   **è®¾ç½®åŸŸåæ‰˜ç®¡**ï¼šä¸ºæ¯ä¸ªé…ç½®æŒ‡å®šåŸŸåæ‰˜ç®¡æœåŠ¡ï¼ˆCloudflareã€é˜¿é‡ŒESAã€è…¾è®¯Edgeoneã€Gcoreã€Fastlyã€CacheFlyã€LightCDNã€Vercelã€Netlifyæˆ–æ— ï¼‰
    *   **å³æ—¶ç¼–è¾‘åé¦ˆ**ï¼šç¼–è¾‘é…ç½®ä¿å­˜åï¼Œåˆ—è¡¨ä¼šç«‹å³æ›´æ–°ï¼Œæ— éœ€é‡æ–°æŸ¥è¯¢ï¼ˆ**v2.1.1æ–°å¢**ï¼‰
    *   **æŸ¥çœ‹ UUID ç»Ÿè®¡**ï¼šä¸ºå½“å‰æŸ¥è¯¢çš„ UUID æ˜¾ç¤ºè®¿é—®ç»Ÿè®¡å›¾è¡¨
    *   **æ·»åŠ æ–°é…ç½®**ï¼šæ‰¹é‡æ·»åŠ æ–°çš„é…ç½®èŠ‚ç‚¹
*   **æ“ä½œæŒ‡å—**ï¼š
    1.  åœ¨"æ£€ç´¢è®¢é˜…"å¡ç‰‡ï¼š
        -   **è¾“å…¥UUID**ï¼šè¾“å…¥è¦æŸ¥è¯¢çš„UUID
        -   **ç‚¹å‡»æŸ¥è¯¢**ï¼šæŸ¥çœ‹è¯¥UUIDä¸‹çš„æ‰€æœ‰é…ç½®
    2.  åœ¨"é…ç½®åˆ—è¡¨"å¡ç‰‡ï¼š
        -   **ç¼–è¾‘é…ç½®**ï¼šç‚¹å‡»ç¼–è¾‘æŒ‰é’®ä¿®æ”¹é…ç½®å‚æ•°ï¼ˆåŒ…æ‹¬åŸŸåæ‰˜ç®¡å±æ€§ï¼‰
        -   **ä¿å­˜ç¼–è¾‘**ï¼šä¿å­˜åç•Œé¢ç«‹å³æ˜¾ç¤ºæœ€æ–°é…ç½®å†…å®¹
        -   **åˆ é™¤é…ç½®**ï¼šåˆ é™¤å•ä¸ªé…ç½®æˆ–æ•´ä¸ªUUIDç»„
    3.  åœ¨"è®¿é—®ç»Ÿè®¡"å¡ç‰‡ï¼š
        -   **æŸ¥çœ‹è¶‹åŠ¿å›¾**ï¼šé€‰æ‹©æ—¶é—´èŒƒå›´ï¼ˆ7/14/30/60å¤©ï¼‰æŸ¥çœ‹è®¿é—®è¶‹åŠ¿
        -   **åˆ‡æ¢å›¾è¡¨ç±»å‹**ï¼šæŸ¥çœ‹æ€»è®¿é—®é‡æˆ–åˆ†ç±»ç»Ÿè®¡
        -   **æŸ¥çœ‹è®¿é—®è®°å½•**ï¼šæŸ¥çœ‹æœ€è¿‘çš„è®¿é—®è®°å½•å’Œå®¢æˆ·ç«¯ä¿¡æ¯
    4.  åœ¨"æ·»åŠ æ–°èŠ‚ç‚¹"å¡ç‰‡ï¼š
        -   **é€‰æ‹©åŸŸåæ‰˜ç®¡**ï¼šé€‰æ‹©é…ç½®ä½¿ç”¨çš„CDNæœåŠ¡å•†
        -   **æ‰¹é‡æ·»åŠ é…ç½®**ï¼šæ”¯æŒå¤šç§åè®®é“¾æ¥æ‰¹é‡æ·»åŠ 

### 3. ç®¡ç†åå° (`mg.example.com`)

*   é¦–æ¬¡è®¿é—® `mg.example.com` ä¼šè·³è½¬åˆ° `/login` é¡µé¢ã€‚
*   é»˜è®¤ç®¡ç†å‘˜è´¦å·ï¼š`admin`ï¼Œå¯†ç ï¼š`password`ã€‚ç™»å½•åè¯·åŠ¡å¿…ä¿®æ”¹å¯†ç ã€‚
*   åœ¨æ­¤é¡µé¢ï¼Œæ‚¨å¯ä»¥ï¼š
    *   **ç³»ç»Ÿæ¦‚è§ˆ**ï¼šæŸ¥çœ‹ç³»ç»ŸçŠ¶æ€å’Œè®¿é—®æ‘˜è¦
    *   **åŸŸåç®¡ç†**ï¼šæ·»åŠ /ç¼–è¾‘/åˆ é™¤ä¼˜é€‰åŸŸå
    *   **IP èµ„æºæ± ç®¡ç†**ï¼š**ç®¡ç† IP æ± ï¼ŒåŒ…æ‹¬æ–°çš„ HostMonit IPv6 å¼€å¯æŒ‰é’®ï¼Œå¹¶æ˜¾ç¤º IP æ¥æº**ï¼Œä»¥åŠè‡ªåŠ¨æ›´æ–°è®¾ç½®ã€‚ç‚¹å‡»"ç«‹å³æ›´æ–°"ä¼šç›´æ¥è°ƒç”¨mg_worker.jså†…ç½®çš„IPæ›´æ–°åŠŸèƒ½
    *   **é…ç½®åˆ†ç»„ç®¡ç†**ï¼šæŸ¥çœ‹å’Œç®¡ç† UUID åˆ†ç»„
    *   **è®¢é˜…åˆ†æ**ï¼šå…¨å±€è®¿é—®ç»Ÿè®¡åˆ†æ
    *   **å®‰å…¨ä¸­å¿ƒ**ï¼šç®¡ç† MFA åŒé‡éªŒè¯

### 4. è®¢é˜…é“¾æ¥

ç”Ÿæˆé…ç½®åï¼Œå¦‚æœä½¿ç”¨äº† UUID æ¨¡å¼ï¼Œç³»ç»Ÿä¼šæä¾›ä¸€ä¸ªæ°¸ä¹…è®¢é˜…é“¾æ¥ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š

*   **IP æ¨¡å¼**: `proxy.example.com/batch-configs/{uuid}?type=ip&ipType=v4&carrier=CT`
*   **åŸŸå æ¨¡å¼**: `proxy.example.com/batch-configs/{uuid}?type=domain`
*   **åè®®æ‰©å±•**ï¼šæ”¯æŒæ‰€æœ‰å·²é…ç½®çš„åè®®ç±»å‹
*   **åŸŸåæ‰˜ç®¡å±æ€§è¿‡æ»¤**ï¼šåªæœ‰Cloudflareå±æ€§çš„é…ç½®ä¼šè¿›è¡Œä¼˜é€‰æ›¿æ¢ï¼Œå…¶ä»–å±æ€§é…ç½®åªè¾“å‡ºåŸé…ç½®

---

## âš™ï¸ ç³»ç»Ÿæ¶æ„

### ç»„ä»¶äº¤äº’æµç¨‹

```mermaid
sequenceDiagram
    participant User as ç”¨æˆ·æµè§ˆå™¨
    participant Main as worker.js
    participant Config as config_worker.js
    participant DB as D1 æ•°æ®åº“
    participant Mg as mg_worker.js

    User->>Config: è®¿é—® /manage (é…ç½®ç®¡ç†)
    Config->>DB: è¯»å†™é…ç½®æ•°æ®
    Config-->>User: è¿”å›ç®¡ç†ç•Œé¢ï¼ˆå«åŸŸåæ‰˜ç®¡å±æ€§ï¼‰

    User->>Main: è®¿é—® / (ç”Ÿæˆå™¨é¦–é¡µ)
    Main->>DB: è¯»å–ä¼˜é€‰IP/åŸŸå
    Main-->>User: è¿”å›ç”Ÿæˆå™¨ç•Œé¢

    User->>Main: æäº¤ç”Ÿæˆè¯·æ±‚
    Main->>DB: è·å–åŸºç¡€é…ç½®ï¼ˆå«åŸŸåæ‰˜ç®¡å±æ€§ï¼‰
    Main->>Main: è¿‡æ»¤å¤„ç†ï¼šCloudflareé…ç½®è¿›è¡Œä¼˜é€‰æ›¿æ¢<br/>éCloudflareé…ç½®è¿”å›åŸé…ç½®
    Main->>DB: è®°å½•è®¿é—®æ—¥å¿—(å¦‚ä½¿ç”¨UUID)
    Main-->>User: è¿”å›é…ç½®ï¼ˆæ‰€æœ‰åŸé…ç½®+Cloudflareä¼˜é€‰é…ç½®ï¼‰

    User->>Config: æŸ¥è¯¢UUIDé…ç½®
    Config->>DB: è·å–é…ç½®åˆ—è¡¨ï¼ˆå«åŸŸåæ‰˜ç®¡å±æ€§ï¼‰
    Config->>DB: è·å–è®¿é—®ç»Ÿè®¡
    Config-->>User: è¿”å›é…ç½®åˆ—è¡¨å’Œç»Ÿè®¡å›¾è¡¨

    User->>Config: ç¼–è¾‘é…ç½®å¹¶ä¿å­˜ (v2.1.1æ–°å¢)
    Config->>DB: æ›´æ–°é…ç½®ï¼ˆåŒ…å«åŸŸåæ‰˜ç®¡å­—æ®µï¼‰
    Config-->>User: ç«‹å³è¿”å›æ›´æ–°åçš„é…ç½®å¯¹è±¡

    User->>Mg: ç‚¹å‡»"ç«‹å³æ›´æ–°IP"
    Mg->>DB: ä¿å­˜è‡ªåŠ¨æ›´æ–°è®¾ç½®
    Mg->>Mg: ç›´æ¥æ‰§è¡ŒIPæ›´æ–°ä»»åŠ¡
    Mg-->>User: æ˜¾ç¤ºæ›´æ–°æˆåŠŸ/å¤±è´¥

    Mg->>Mg: å®šæ—¶ä»»åŠ¡æ›´æ–°IP
    Mg->>DB: è¯»å–è®¾ç½®å¹¶æ‰§è¡ŒIPæ›´æ–°
```

### åŸŸåæ‰˜ç®¡å±æ€§å¤„ç†é€»è¾‘

```mermaid
graph TD
    A[å¼€å§‹å¤„ç†é…ç½®] --> B{åŸŸåæ‰˜ç®¡å±æ€§æ£€æŸ¥}
    B -->|å±æ€§ä¸º Cloudflare| C[è¾“å‡ºåŸé…ç½®]
    C --> D[ä¸ºæ¯ä¸ªä¼˜é€‰åœ°å€ç”Ÿæˆæ–°é…ç½®]
    D --> E[æ·»åŠ åˆ°ç»“æœæ•°ç»„]
    B -->|å±æ€§ä¸ºé Cloudflare| F[åªè¾“å‡ºåŸé…ç½®]
    F --> G[æ·»åŠ åˆ°ç»“æœæ•°ç»„]
    E --> H[ç»§ç»­å¤„ç†ä¸‹ä¸ªé…ç½®]
    G --> H
```

### æ¥å£è°ƒç”¨å…³ç³»

| è°ƒç”¨æ–¹         | è¢«è°ƒç”¨æ–¹           | æ¥å£è·¯å¾„                            | æ•°æ®æµå‘                       |
| :------------- | :----------------- | :---------------------------------- | :----------------------------- |
| `worker.js`    | `config_worker.js` | `/api/configs/:uuid`                | æ‹‰å–åŸºç¡€é…ç½®ï¼ˆå«åŸŸåæ‰˜ç®¡å±æ€§ï¼‰ |
| `worker.js`    | `mg_worker.js`     | `/api/ips`                          | è·å–ä¼˜é€‰IP                     |
| `worker.js`    | `mg_worker.js`     | `/api/domains`                      | è·å–ä¼˜é€‰åŸŸå                   |
| `worker.js`    | `config_worker.js` | `/api/access_log`                   | è®°å½•è®¿é—®æ—¥å¿—                   |
| ç”¨æˆ·æµè§ˆå™¨     | `mg_worker.js`     | `/api/login` (åŠå…¶ä»–`/api`å‰ç¼€æ¥å£) | ç®¡ç†åå°æ“ä½œ                   |
| ç”¨æˆ·æµè§ˆå™¨     | `mg_worker.js`     | `/api/stats`                        | å…¨å±€è®¢é˜…ç»Ÿè®¡åˆ†æ               |
| ç”¨æˆ·æµè§ˆå™¨     | `config_worker.js` | `/api/stats/uuid/:uuid`             | æŸ¥è¯¢ç‰¹å®šUUIDè®¿é—®ç»Ÿè®¡           |

## ğŸ“¡ API æ¥å£æ–‡æ¡£

### mg_worker.js æ¥å£ï¼š

| æ–¹æ³•     | è·¯å¾„                        | æè¿°                       | å‚æ•°ç¤ºä¾‹                                                     |
| :------- | :-------------------------- | :------------------------- | :----------------------------------------------------------- |
| `GET`    | `/`                         | ç®¡ç†åå°é¦–é¡µUI             | -                                                            |
| `POST`   | `/api/login`                | ç®¡ç†å‘˜ç™»å½•                 | JSON body                                                    |
| `GET`    | `/api/domains`              | è·å–åŸŸååˆ—è¡¨               | `?page=1&size=10&sort=domain&order=asc`                      |
| `POST`   | `/api/domains`              | æ·»åŠ åŸŸå                   | `{"domain":"new.site.com", "remark":"æ–°åŸŸå"}`               |
| `PUT`    | `/api/domains`              | æ›´æ–°åŸŸå                   | `{"id":1, "domain":"updated.com", "remark":"æ›´æ–°"}`          |
| `DELETE` | `/api/domains`              | åˆ é™¤åŸŸå                   | `{"id":1}`                                                   |
| `GET`    | `/api/ips`                  | è·å–IPåˆ—è¡¨                 | `?page=1&size=20&sort=ip&order=desc`                         |
| `POST`   | `/api/ips/update`           | **ç›´æ¥æ‰§è¡ŒIPæ›´æ–°**         | `{"global_enabled":true, "hostmonit_v4":true, "hostmonit_v6":false, "vps789":true}` |
| `DELETE` | `/api/ips`                  | åˆ é™¤IP                     | `{"ip":"1.1.1.1"}`                                           |
| `GET`    | `/api/uuids`                | è·å–UUIDåˆ—è¡¨               | `?page=1&size=10&sort=updated_at&order=desc`                 |
| `DELETE` | `/api/uuids`                | åˆ é™¤UUIDåˆ†ç»„åŠå…¶æ‰€æœ‰é…ç½®   | `{"uuid":"some_uuid"}`                                       |
| `GET`    | `/api/settings/auto-update` | è·å–è‡ªåŠ¨æ›´æ–°è®¾ç½®           | -                                                            |
| `POST`   | `/api/settings/auto-update` | æ›´æ–°è‡ªåŠ¨æ›´æ–°è®¾ç½®           | `{"global_enabled": true, "hostmonit_v4": true, "hostmonit_v6": false, "vps789": true}` |
| `GET`    | `/api/stats`                | è·å–ç³»ç»Ÿæ¦‚è§ˆåŠå…¨å±€è®¿é—®ç»Ÿè®¡ | `?days=30` (é»˜è®¤30å¤©)                                        |
| `GET`    | `/api/stats/uuid-details`   | è·å–æŒ‡å®šUUIDçš„è¯¦ç»†è®¿é—®è®°å½• | `?uuid={uuid}&start_date=xxx&end_date=xxx`                   |

### worker.js æ¥å£ï¼š

| æ–¹æ³•   | è·¯å¾„                   | æè¿°                     | å‚æ•°ç¤ºä¾‹                                                     |
| :----- | :--------------------- | :----------------------- | :----------------------------------------------------------- |
| `GET`  | `/`                    | ä¸»ç”Ÿæˆå™¨UI               | -                                                            |
| `GET`  | `/fetch-addresses`     | è·å–ä¼˜é€‰åœ°å€åˆ—è¡¨         | `?type=ip&ipType=v4&carrier=CT&source=database`              |
| `GET`  | `/batch-ip`            | è·å–ä¼˜é€‰åˆ—è¡¨æ–‡æœ¬         | `?type=ip&ipType=v4&carrier=CT`                              |
| `GET`  | `/fetch-ips`           | è·å–IPåˆ—è¡¨ï¼ˆå…¼å®¹æ—§æ¥å£ï¼‰ | `?ipType=all&carrierType=all`                                |
| `GET`  | `/batch-configs/:uuid` | ç”Ÿæˆè®¢é˜…é“¾æ¥ï¼ˆåŸºäºUUIDï¼‰ | `?type=ip&ipType=v4&carrier=CT`                              |
| `POST` | `/generate`            | æ‰‹åŠ¨ç”Ÿæˆé…ç½®             | `{"addressList":"1.1.1.1\n2.2.2.2", "baseConfigUuid":"xxx"}` |

### config_worker.js æ¥å£ (v2.0+)ï¼š

| æ–¹æ³•     | è·¯å¾„                     | æè¿°             | å‚æ•°ç¤ºä¾‹                                                     |
| :------- | :----------------------- | :--------------- | :----------------------------------------------------------- |
| `GET`    | `/`                      | é…ç½®ç®¡ç†å™¨UI     | -                                                            |
| `GET`    | `/manage/configs/:uuid`  | è·å–UUIDé…ç½®åˆ—è¡¨ | -                                                            |
| `GET`    | `/manage/stats/:uuid`    | è·å–UUIDè®¿é—®ç»Ÿè®¡ | `?days=30` (é»˜è®¤30å¤©)                                        |
| `POST`   | `/manage/configs`        | æ‰¹é‡æ·»åŠ é…ç½®     | `{"uuid":"xxx", "config_data":"vmess://...", "domain_hosting":"Cloudflare"}` |
| `PUT`    | `/manage/configs`        | æ›´æ–°å•ä¸ªé…ç½®     | `{"id":123, "config_data":"vmess://...", "domain_hosting":"Cloudflare"}` |
| `DELETE` | `/manage/configs`        | åˆ é™¤æŒ‡å®šUUIDç»„   | è·¯å¾„å‚æ•°: `/:uuid`                                           |
| `DELETE` | `/manage/configs/id/:id` | åˆ é™¤å•ä¸ªé…ç½®     | -                                                            |

### ç»Ÿè®¡æ¥å£è¯´æ˜

#### 1. è·å–UUIDè®¿é—®ç»Ÿè®¡ (`GET /manage/stats/:uuid` by `config_worker.js`)

è¿”å›æŒ‡å®šUUIDçš„è¯¦ç»†è®¿é—®ç»Ÿè®¡ä¿¡æ¯ï¼Œæ”¯æŒæ—¶é—´èŒƒå›´å‚æ•°ï¼š

- **days**: æŸ¥è¯¢å¤©æ•°ï¼ˆ7/14/30/60å¤©ï¼‰ï¼Œä¾‹å¦‚ `?days=14`

å“åº”æ ¼å¼ç¤ºä¾‹ï¼š

```json
{
  "success": true,
  "uuid": "my-uuid-123",
  "total_access": 150,
  "subscription_count": 120,
  "apigen_count": 30,
  "first_access": 1705307400000, // Unix timestamp (ms)
  "last_access": 1705742700000,   // Unix timestamp (ms)
  "today_total": 15,
  "today_subscription": 12,
  "today_apigen": 3,
  "daily_stats": [
    {
      "date": "2024-01-20",
      "total": 25,
      "subscription": 20,
      "api_generation": 5
    }
  ],
  "recent_logs": [
    {
      "uuid": "my-uuid-123",
      "query_type": "subscription",
      "client_ip": "123.123.123.123",
      "user_agent": "Clash/2.0",
      "created_at": 1705742700000 // Unix timestamp (ms)
    }
  ]
}
```

#### 2. è·å–ç³»ç»Ÿç»Ÿè®¡ (`GET /api/stats` by `mg_worker.js`)

è¿”å›å®Œæ•´çš„ç³»ç»Ÿç»Ÿè®¡ä¿¡æ¯ï¼ŒåŒ…æ‹¬ï¼š

-   **åŸºç¡€ç»Ÿè®¡**: åŸŸåæ•°ã€IPæ•°ã€UUIDåˆ†ç»„æ•°ã€è‡ªåŠ¨æ›´æ–°çŠ¶æ€
-   **è®¿é—®ç»Ÿè®¡**: æ€»è®¿é—®æ¬¡æ•°ã€ä»Šæ—¥è®¿é—®ã€è®¢é˜…è®¿é—®ã€ç½‘é¡µç”Ÿæˆè®¿é—®
-   **è¶‹åŠ¿æ•°æ®**: è¿‘Nå¤©çš„æ¯æ—¥è®¿é—®æ•°æ®
-   **çƒ­é—¨UUID**: è®¿é—®æ¬¡æ•°æœ€å¤šçš„UUIDæ’è¡Œ

å“åº”æ ¼å¼ç¤ºä¾‹ï¼š

```json
{
  "domains": 15,
  "ips": 256,
  "uuids": 8,
  "autoUpdate": 1, // 0è¡¨ç¤ºå…³é—­ï¼Œ1è¡¨ç¤ºå¼€å¯
  "lastExecuted": 1707907200000, // Unix timestamp (ms)
  "access_stats": {
    "success": true,
    "total_requests": 150,
    "unique_uuids": 8,
    "subscription_requests": 120,
    "api_generation_requests": 30,
    "today_total": 15,
    "today_subscription": 12,
    "today_apigen": 3,
    "daily_stats": [
       {"date": "2024-02-14", "total": 10, "subscription": 8, "api_generation": 2, "unique_uuids": 5}
    ],
    "popular_uuids": [
       {"uuid": "uuid-abc", "access_count": 50, "subscription_count": 40, "apigen_count": 10}
    ]
  }
}
```

#### 3. è·å–UUIDè¯¦ç»†è®¿é—®è®°å½• (`GET /api/stats/uuid-details` by `mg_worker.js`)

è¿”å›æŒ‡å®šUUIDçš„è¯¦ç»†è®¿é—®è®°å½•ï¼Œæ”¯æŒæ—¶é—´èŒƒå›´ç­›é€‰ã€‚

-   **uuid**: å¿…å¡«ï¼Œè¦æŸ¥è¯¢çš„ UUID
-   **start_date**: å¯é€‰ï¼Œèµ·å§‹æ—¥æœŸï¼Œæ ¼å¼ `YYYY-MM-DD`
-   **end_date**: å¯é€‰ï¼Œç»“æŸæ—¥æœŸï¼Œæ ¼å¼ `YYYY-MM-DD`

å“åº”æ ¼å¼ç¤ºä¾‹ï¼š

```json
{
  "success": true,
  "uuid": "my-config-group",
  "total_access": 45,
  "first_access": 1705307400000, // Unix timestamp (ms)
  "last_access": 1705742700000,   // Unix timestamp (ms)
  "access_logs": [
    {
      "uuid": "my-config-group",
      "query_type": "subscription",
      "client_ip": "123.123.123.123",
      "user_agent": "Clash/2.0",
      "created_at": 1705742700000 // Unix timestamp (ms)
    },
    // ...æ›´å¤šè®°å½•
  ]
}
```

### MFAç›¸å…³æ¥å£ï¼š

| æ–¹æ³•   | è·¯å¾„                               | æè¿°                        |
| ------ | ---------------------------------- | --------------------------- |
| `POST` | `/api/mfa/init`                    | åˆå§‹åŒ–MFAï¼Œè·å–å¯†é’¥å’ŒäºŒç»´ç  |
| `POST` | `/api/mfa/verify-first`            | é¦–æ¬¡éªŒè¯MFAå¹¶å¯ç”¨           |
| `POST` | `/api/mfa/login-with-backup`       | ä½¿ç”¨å¤‡ä»½ç ç™»å½•              |
| `GET`  | `/api/mfa/status`                  | è·å–MFAçŠ¶æ€                 |
| `POST` | `/api/mfa/disable`                 | ç¦ç”¨MFA                     |
| `POST` | `/api/mfa/backup-codes/regenerate` | é‡æ–°ç”Ÿæˆå¤‡ä»½ç               |

### è‡ªåŠ¨æ›´æ–°è®¾ç½®æ¥å£è¯´æ˜

- **è·å–è‡ªåŠ¨æ›´æ–°è®¾ç½®** (`GET /api/settings/auto-update`): 
  è¿”å›å½“å‰è‡ªåŠ¨æ›´æ–°é…ç½®ï¼ŒåŒ…æ‹¬æ¯ä¸ªæ•°æ®æº (`global_enabled`, `hostmonit_v4`, `hostmonit_v6`, `vps789`) çš„å¯ç”¨çŠ¶æ€ï¼Œä»¥åŠ `last_executed` æ—¶é—´æˆ³ã€‚

- **æ›´æ–°è‡ªåŠ¨æ›´æ–°è®¾ç½®** (`POST /api/settings/auto-update`): 
  æ›´æ–°è‡ªåŠ¨æ›´æ–°é…ç½®ã€‚è¯·æ±‚ä½“ä¸ºJSONæ ¼å¼ï¼Œç¤ºä¾‹ï¼š

  ```json
  { 
    "global_enabled": true, 
    "hostmonit_v4": true,
    "hostmonit_v6": false, 
    "vps789": true 
  }
  ```

---

## ğŸ“Š ç‰ˆæœ¬æ›´æ–°å†å²

### v3.0 (æœ€æ–°)

-   **åˆå¹¶IPæ›´æ–°åŠŸèƒ½**ï¼šå°†åŸip-worker.jsçš„åŠŸèƒ½å®Œæ•´åˆå¹¶åˆ°mg_worker.jsä¸­ï¼Œç®€åŒ–éƒ¨ç½²æ¶æ„
    -   ç§»é™¤ç‹¬ç«‹çš„ip-worker.jsæ–‡ä»¶ï¼Œå‡å°‘Workeræ•°é‡
    -   mg_worker.jsç°åœ¨ç›´æ¥å¤„ç†IPæ›´æ–°ä»»åŠ¡ï¼Œæ— éœ€ä»£ç†è°ƒç”¨
    -   æ›´æ–°readme.mdæ–‡æ¡£ï¼Œåæ˜ æ–°çš„ä¸‰Workeræ¶æ„
-   **æ¥å£ä¼˜åŒ–**ï¼šmg_worker.jsçš„`/api/ips/update`æ¥å£ç°åœ¨æ˜¯ç›´æ¥æ‰§è¡ŒIPæ›´æ–°ï¼Œä¸å†ä»£ç†è°ƒç”¨å¤–éƒ¨Worker

### v2.3.0

-   **æ•°æ®åº“æ¸…ç†ä¼˜åŒ–**ï¼šç§»é™¤æœªä½¿ç”¨çš„æ•°æ®åº“è¡¨ï¼Œç®€åŒ–æ•°æ®åº“ç»“æ„
    -   ç§»é™¤ `users`, `uuids`, `system_logs`, `api_access_stats` ç­‰æœªä½¿ç”¨çš„è¡¨
    -   åªä¿ç•™å®é™…ä½¿ç”¨çš„è¡¨ï¼š`configs`, `config_access_logs`, `cfips`, `cf_domains`, `auto_update_settings`, `admin_users`, `mfa_backup_codes`
    -   ç§»é™¤é‡å¤çš„ `config_access_logs` è¡¨å®šä¹‰
    -   ç®€åŒ–åˆå§‹åŒ–è„šæœ¬ï¼Œæé«˜éƒ¨ç½²æ•ˆç‡
-   **æ•°æ®åº“ç»“æ„ä¼˜åŒ–**ï¼šå‡å°‘å†—ä½™å­—æ®µï¼Œä¼˜åŒ–ç´¢å¼•é…ç½®
    -   `cfips` è¡¨ç§»é™¤ `latency` å­—æ®µï¼ˆæœªä½¿ç”¨ï¼‰
    -   `auto_update_settings` è¡¨ç§»é™¤ `update_interval` å­—æ®µï¼ˆæœªä½¿ç”¨ï¼‰
-   **ä»£ç æ¸…ç†**ï¼šæ ¹æ®ä»£ç åˆ†æç»“æœï¼Œç¡®ä¿æ•°æ®åº“ä¸ä»£ç ä½¿ç”¨å®Œå…¨ä¸€è‡´

### v2.2.0

-   **åŸŸåæ‰˜ç®¡å±æ€§æ‰©å±•**ï¼šæ”¯æŒå¤šç§CDNå‚å•†ï¼Œå¢åŠ Gcoreã€Fastlyã€CacheFlyã€LightCDNã€Vercelã€Netlifyç­‰åŸŸåæ‰˜ç®¡é€‰é¡¹
-   **æ™ºèƒ½ä¼˜é€‰è¿‡æ»¤**ï¼šä¼˜é€‰é…ç½®ç”Ÿæˆå™¨æ ¹æ®åŸŸåæ‰˜ç®¡å±æ€§æ™ºèƒ½å¤„ç†é…ç½®
    -   Cloudflareå±æ€§é…ç½®ï¼šè¿›è¡Œä¼˜é€‰æ›¿æ¢ï¼ˆè¾“å‡ºåŸé…ç½®+ä¼˜é€‰é…ç½®ï¼‰
    -   éCloudflareå±æ€§é…ç½®ï¼šåªè¾“å‡ºåŸé…ç½®ï¼Œä¸è¿›è¡Œä¼˜é€‰æ›¿æ¢
    -   æ‰€æœ‰é…ç½®éƒ½è¾“å‡ºåŸé…ç½®
-   **å½©è‰²å¾½ç« æ ‡è¯†**ï¼šå‰ç«¯ä¸ºä¸åŒåŸŸåæ‰˜ç®¡ç±»å‹æ˜¾ç¤ºå½©è‰²å¾½ç« 
-   **å¢åŠ "æ— "é€‰é¡¹**ï¼šæ”¯æŒæ ‡è®°é…ç½®ä¸ºä¸ä½¿ç”¨åŸŸåæ‰˜ç®¡
-   **æ•°æ®åº“ç»“æ„æ›´æ–°**ï¼š`configs`è¡¨æ·»åŠ `domain_hosting`å­—æ®µ
-   **APIæ¥å£æ‰©å±•**ï¼šé…ç½®ç®¡ç†æ¥å£æ”¯æŒåŸŸåæ‰˜ç®¡å±æ€§å‚æ•°

### v2.1.1

-   **åè®®æ‰©å±•æ”¯æŒ**ï¼šåœ¨åŸæœ‰ VMessã€VLESSã€Trojan åè®®åŸºç¡€ä¸Šï¼Œå¢åŠ å¯¹ Shadowsocks (ss)ã€ShadowsocksR (ssr) ç­‰æ›´å¤šä¸»æµä»£ç†åè®®çš„æ”¯æŒ
-   **é…ç½®ç¼–è¾‘å³æ—¶åé¦ˆ**ï¼šä¼˜åŒ– `config_worker.js` çš„ `PUT /api/configs` æ¥å£ï¼Œç¼–è¾‘é…ç½®å¹¶ä¿å­˜åï¼ŒAPIæ¥å£ç«‹å³è¿”å›æ›´æ–°åçš„å®Œæ•´é…ç½®å¯¹è±¡ï¼Œå‰ç«¯æ— éœ€é‡æ–°æŸ¥è¯¢å³å¯æ›´æ–°ç•Œé¢æ˜¾ç¤º
-   **åè®®è§£æå™¨å¢å¼º**ï¼šæ›´æ–°é…ç½®è§£æé€»è¾‘ï¼Œæ”¯æŒæ›´å¤šåè®®çš„æ ‡å‡†æ ¼å¼è§£æ
-   **ç”¨æˆ·ä½“éªŒä¼˜åŒ–**ï¼šé…ç½®ç®¡ç†é¡µé¢ç¼–è¾‘æ“ä½œæ›´åŠ æµç•…ï¼Œå‡å°‘ä¸å¿…è¦çš„æ•°æ®åˆ·æ–°
-   **ä¿æŒå‘åå…¼å®¹**ï¼šæ‰€æœ‰ç°æœ‰æ¥å£å’ŒåŠŸèƒ½ä¿æŒå®Œå…¨å…¼å®¹ï¼Œä»…è¿›è¡ŒåŠŸèƒ½å¢å¼º

### v2.1

-   **æ”¯æŒ IPv6 åœ°å€è·å–ä¸ç®¡ç†**ï¼šæ–°å¢ HostMonit IPv6 æ¥å£ï¼Œå¯åœ¨ç®¡ç†åå°å¯ç”¨ã€‚
-   **IP æ¥æºè¿½è¸ª**ï¼š`cfips` è¡¨æ–°å¢ `source` å­—æ®µï¼Œè®°å½•æ¯ä¸ª IP çš„å…·ä½“æ¥æºï¼ˆHostMonit IPv4/IPv6, Vps789ï¼‰ã€‚
-   **ç®¡ç†åå°ç•Œé¢ä¼˜åŒ–**ï¼š
    *   IP èµ„æºæ± ç®¡ç†ç•Œé¢å¢åŠ  HostMonit IPv6 å¼€å…³æŒ‰é’®ã€‚
    *   IP åˆ—è¡¨è¡¨æ ¼æ–°å¢"æ¥æº"åˆ—ï¼Œç›´è§‚æ˜¾ç¤º IP æ¥æºã€‚
    *   IP åœ°å€å­˜å‚¨ä¸å†åŒ…å« `[]`ï¼Œä¿æŒçº¯å‡€æ ¼å¼ã€‚
-   **è‡ªåŠ¨æ›´æ–°è®¾ç½®å¢å¼º**ï¼šç®¡ç†åå°çš„è‡ªåŠ¨æ›´æ–°è®¾ç½®æ”¯æŒå¯¹ IPv4 å’Œ IPv6 æ¥æºåˆ†åˆ«é…ç½®ã€‚

### v2.0

-   **å¢å¼ºé…ç½®ç®¡ç†å™¨**ï¼šä¸ºæ¯ä¸ªUUIDæä¾›ä¸“å±è®¿é—®ç»Ÿè®¡å›¾è¡¨
-   **æ–°å¢å®æ—¶è¶‹åŠ¿åˆ†æ**ï¼šåœ¨é…ç½®ç®¡ç†é¡µé¢å±•ç¤ºè®¿é—®è¶‹åŠ¿æŠ˜çº¿å›¾
-   **å¢åŠ è®¿é—®è®°å½•åŠŸèƒ½**ï¼šæ˜¾ç¤ºæœ€è¿‘è®¿é—®è®°å½•å’Œå®¢æˆ·ç«¯ä¿¡æ¯
-   **ä¼˜åŒ–ç”¨æˆ·ä½“éªŒ**ï¼šæ›´ç›´è§‚çš„æ•°æ®å±•ç¤ºå’Œäº¤äº’å¼å›¾è¡¨
-   **æ‰©å±•ç»Ÿè®¡æ¥å£**ï¼šæä¾›æ›´çµæ´»çš„ç»Ÿè®¡æŸ¥è¯¢é€‰é¡¹
-   **æ—¥å¿—è®°å½•**ï¼šæ–°å¢è®¿é—®æ—¥å¿—è®°å½•åŠŸèƒ½

### v1.4

-   æ–°å¢MFAåŒé‡éªŒè¯åŠŸèƒ½
-   æ”¯æŒTOTPéªŒè¯å’Œå¤‡ä»½ç ç™»å½•
-   å¢å¼ºç³»ç»Ÿå®‰å…¨æ€§

### v1.3

-   æ–°å¢è‡ªåŠ¨æ›´æ–°IPæ± åŠŸèƒ½
-   æ”¯æŒå¤šä¸ªIPæ•°æ®æºé…ç½®
-   æ·»åŠ è‡ªåŠ¨æ›´æ–°ç®¡ç†ç•Œé¢

### v1.2

-   æ–°å¢é…ç½®ç®¡ç†é¡µé¢
-   æ”¯æŒé…ç½®CRUDæ“ä½œ
-   æ·»åŠ åŸŸåç®¡ç†åŠŸèƒ½
-   æ”¹è¿›è®¢é˜…é“¾æ¥æ˜¾ç¤º

### v1.1

-   åˆå§‹ç¨³å®šç‰ˆæœ¬
-   æ”¯æŒIP/åŸŸåä¼˜é€‰æ›¿æ¢
-   æä¾›è®¢é˜…æ¥å£
-   åŸºç¡€ç®¡ç†åŠŸèƒ½
## ğŸ¯ é€‚ç”¨åœºæ™¯

1.  **ä»£ç†é…ç½®æ‰¹é‡ç®¡ç†**ï¼šé€‚åˆç®¡ç†å¤šä¸ªä»£ç†é…ç½®ï¼Œé¿å…é‡å¤ä¿®æ”¹
2.  **IPä¼˜é€‰æœåŠ¡**ï¼šä¸ºä»£ç†æä¾›ä¼˜åŒ–çš„Cloudflare IPå’ŒåŸŸå
3.  **è®¢é˜…æœåŠ¡åˆ†å‘**ï¼šé€šè¿‡UUIDåˆ†ç»„ä¸ºä¸åŒç”¨æˆ·æä¾›å®šåˆ¶è®¢é˜…
4.  **ä½¿ç”¨æƒ…å†µåˆ†æ**ï¼šé€šè¿‡ç»Ÿè®¡åˆ†æäº†è§£é…ç½®çš„ä½¿ç”¨æƒ…å†µå’Œçƒ­åº¦
5.  **å¤šåè®®æ”¯æŒ**ï¼šæ”¯æŒå¤šç§ä¸»æµä»£ç†åè®®çš„ç»Ÿä¸€ç®¡ç†ï¼ˆVMess, VLESS, Trojan, Shadowsocks, ShadowsocksRç­‰ï¼‰
6.  **å¤šCDNå‚å•†ç®¡ç†**ï¼šæ”¯æŒæŒ‰ä¸åŒCDNæœåŠ¡å•†åˆ†ç±»ç®¡ç†é…ç½®

## ğŸ”§ æŠ€æœ¯æ ˆ

-   **è¿è¡Œç¯å¢ƒ**: Cloudflare Workers (æ— æœåŠ¡å™¨è¾¹ç¼˜è®¡ç®—)
-   **æ•°æ®åº“**: Cloudflare D1 (åŸºäºSQLiteçš„åˆ†å¸ƒå¼æ•°æ®åº“)
-   **å‰ç«¯æ¡†æ¶**: çº¯HTML/CSS/JavaScriptï¼Œæ— æ¡†æ¶ä¾èµ–
-   **å›¾è¡¨åº“**: Chart.js (ç”¨äºæ•°æ®å¯è§†åŒ–)
-   **è®¤è¯ç³»ç»Ÿ**: JWT + TOTPåŒé‡éªŒè¯
-   **é€šè®¯åè®®**: æ”¯æŒVMessã€VLESSã€Trojanã€Shadowsocksã€ShadowsocksRç­‰å¤šç§åè®®

---

**å…è´£å£°æ˜**ï¼šæœ¬å·¥å…·ä»…ä¾›å­¦ä¹ å’Œç ”ç©¶ä½¿ç”¨ï¼Œè¯·éµå®ˆå½“åœ°æ³•å¾‹æ³•è§„ï¼Œä¸å¾—ç”¨äºéæ³•ç”¨é€”ã€‚ä½œè€…ä¸æ‰¿æ‹…ä»»ä½•ä½¿ç”¨æœ¬å·¥å…·äº§ç”Ÿçš„æ³•å¾‹è´£ä»»ã€‚
